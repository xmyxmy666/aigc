<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½AIGCæ£€æµ‹ä¸ä¼˜åŒ–å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .content-area {
            display: none;
        }

        .content-area.active {
            display: block;
        }

        .text-input {
            width: 100%;
            min-height: 300px;
            padding: 20px;
            border: 2px solid #e1e8ed;
            border-radius: 15px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
            line-height: 1.6;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #e9ecef;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .result-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border-left: 5px solid #667eea;
        }

        .detection-result {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .ai-probability {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
        }

        .probability-label {
            font-size: 1.2rem;
            color: #495057;
        }

        .risk-level {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .risk-high {
            background: #fee;
            color: #c53030;
        }

        .risk-medium {
            background: #fffaf0;
            color: #dd6b20;
        }

        .risk-low {
            background: #f0fff4;
            color: #38a169;
        }

        .analysis-details {
            margin-top: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .progress-bar {
            width: 100px;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.5s ease;
        }

        .suggestions {
            margin-top: 20px;
        }

        .suggestion-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .suggestion-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .suggestion-text {
            color: #666;
            line-height: 1.5;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .optimized-text {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f4f8;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8f4f8;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #495057;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .accuracy-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #856404;
        }

        .accuracy-notice .title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #7c6d03;
        }

        .file-input {
            display: none;
        }

        .file-info {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
            display: none;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .plagiarism-report {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .similarity-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .similarity-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .similarity-percentage {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .similarity-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .content-analysis {
            margin-top: 30px;
        }

        .text-segment {
            margin-bottom: 15px;
            line-height: 1.8;
        }

        .original-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #6c757d;
        }

        .plagiarized-text {
            background: #fff5f5;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #e53e3e;
            margin-top: 10px;
        }

        .highlight-red {
            background-color: #fed7d7;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .highlight-yellow {
            background-color: #fef5e7;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .highlight-green {
            background-color: #f0fff4;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .source-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .source-link {
            color: #1976d2;
            text-decoration: none;
        }

        .source-link:hover {
            text-decoration: underline;
        }

        .plagiarism-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .reduction-suggestions {
            margin-top: 30px;
        }

        .suggestion-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .suggestion-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .suggestion-icon {
            font-size: 1.2rem;
            margin-right: 10px;
            color: #667eea;
        }

        .original-snippet {
            background: #fff5f5;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .improved-snippet {
            background: #f0fff4;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .progress-ring .background {
            stroke: #e9ecef;
        }

        .progress-ring .progress {
            stroke: #dc3545;
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .upload-progress {
            display: none;
            margin-top: 15px;
        }

        .progress-container {
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin-bottom: 10px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }

        .file-preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            display: none;
        }

        .preview-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        .content-preview {
            color: #666;
        }

        .upload-mode-switch {
            text-align: center;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 8px 20px;
            margin: 0 5px;
            border: 2px solid #667eea;
            background: transparent;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .mode-btn:hover {
            background: #667eea;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .detection-result {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– æ™ºèƒ½AIGCæ£€æµ‹ä¸ä¼˜åŒ–å·¥å…·</h1>
            <p>ä¸“ä¸šçš„AIå†…å®¹æ£€æµ‹ä¸äººå·¥åŒ–æ”¹å†™åŠ©æ‰‹</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('detection')">ğŸ” AIGCæ£€æµ‹</button>
            <button class="tab" onclick="switchTab('plagiarism')">ğŸ“‹ æ–‡æ¡£æŸ¥é‡</button>
            <button class="tab" onclick="switchTab('optimization')">âœï¸ æ™ºèƒ½é™é‡</button>
        </div>

        <!-- AIGCæ£€æµ‹åŒºåŸŸ -->
        <div id="detection" class="content-area active">
            <div class="upload-mode-switch">
                <button class="mode-btn" id="detectionTextMode" onclick="switchDetectionMode('text')">ğŸ“ æ–‡æœ¬è¾“å…¥</button>
                <button class="mode-btn active" id="detectionFileMode" onclick="switchDetectionMode('file')">ğŸ“„ æ–‡æ¡£ä¸Šä¼ </button>
            </div>

            <div id="detectionUploadArea" class="upload-area" onclick="document.getElementById('detectionFileInput').click()" 
                 ondrop="handleDetectionFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡æ¡£è¿›è¡ŒAIGCæ£€æµ‹</div>
                <div class="upload-hint">æ”¯æŒ PDFã€DOCã€DOCXã€TXT æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                <input type="file" id="detectionFileInput" class="file-input" accept=".pdf,.doc,.docx,.txt" onchange="handleDetectionFileSelect(event)">
            </div>

            <div class="upload-progress" id="detectionUploadProgress">
                <div class="progress-container">
                    <div class="progress-bar-fill" id="detectionProgressFill"></div>
                </div>
                <div class="progress-text" id="detectionProgressText">ä¸Šä¼ ä¸­... 0%</div>
            </div>

            <div class="file-info" id="detectionFileInfo" style="display: none;">
                <div class="file-name" id="detectionFileName"></div>
                <div class="file-size" id="detectionFileSize"></div>
            </div>

            <div class="file-preview" id="detectionFilePreview">
                <div class="preview-header">æ–‡æ¡£å†…å®¹é¢„è§ˆï¼š</div>
                <div class="content-preview" id="detectionPreviewContent"></div>
            </div>

            <div class="accuracy-notice" id="detectionAccuracyNotice" style="display: none;">
                <div class="title">ğŸ’¡ æ£€æµ‹ç²¾åº¦æç¤º</div>
                <div>ä¸ºè·å¾—æœ€å‡†ç¡®çš„æ£€æµ‹ç»“æœï¼Œå»ºè®®ï¼š</div>
                <div>1. ä¸Šä¼ çº¯æ–‡æœ¬(.txt)æ ¼å¼ä»¥è·å¾—100%å‡†ç¡®çš„å­—æ•°ç»Ÿè®¡</div>
                <div>2. å½“å‰DOCXè§£æä¸ºæ™ºèƒ½ä¼°ç®—ï¼Œå­—æ•°å¯èƒ½ä¸å®é™…æœ‰å·®å¼‚</div>
                <div>3. å¯ä»¥å°†Wordæ–‡æ¡£å¦å­˜ä¸ºtxtæ ¼å¼åé‡æ–°ä¸Šä¼ </div>
            </div>

            <textarea class="text-input" id="detectionText" placeholder="è¯·åœ¨æ­¤è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬å†…å®¹..." style="display: none;"></textarea>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="analyzeText()">ğŸš€ å¼€å§‹æ£€æµ‹</button>
                <button class="btn btn-secondary" onclick="clearDetectionText()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                <button class="btn btn-secondary" onclick="loadSampleText()">ğŸ“ åŠ è½½ç¤ºä¾‹</button>
            </div>

            <div class="loading" id="detectionLoading">
                <div class="spinner"></div>
                <p>æ­£åœ¨åˆ†ææ–‡æœ¬ç‰¹å¾ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="result-panel" id="detectionResult" style="display: none;">
                <div class="detection-result">
                    <div>
                        <div class="ai-probability" id="aiProbability">0%</div>
                        <div class="probability-label">AIç”Ÿæˆæ¦‚ç‡</div>
                    </div>
                    <div>
                        <div class="risk-level" id="riskLevel">ä½é£é™©</div>
                    </div>
                </div>

                <div class="analysis-details">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ“Š è¯¦ç»†åˆ†æ</h3>
                    
                    <div class="detail-item">
                        <span>å¥å­ç»“æ„è§„å¾‹æ€§</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="structureScore" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <span>è¯æ±‡é‡å¤ç¨‹åº¦</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="repetitionScore" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <span>è¯­è¨€æµç•…åº¦</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="fluencyScore" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="detail-item">
                        <span>æƒ…æ„Ÿè¡¨è¾¾ä¸°å¯Œåº¦</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="emotionScore" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="statistics">
                    <div class="stat-card">
                        <div class="stat-number" id="wordCount">0</div>
                        <div class="stat-label">æ€»å­—æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="sentenceCount">0</div>
                        <div class="stat-label">å¥å­æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgSentenceLength">0</div>
                        <div class="stat-label">å¹³å‡å¥é•¿</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="vocabularyRichness">0%</div>
                        <div class="stat-label">è¯æ±‡ä¸°å¯Œåº¦</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡æ¡£æŸ¥é‡åŒºåŸŸ -->
        <div id="plagiarism" class="content-area">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()" 
                 ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡æ¡£</div>
                <div class="upload-hint">æ”¯æŒ PDFã€DOCã€DOCXã€TXT æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.txt" onchange="handleFileSelect(event)">
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <textarea class="text-input" id="plagiarismText" placeholder="æˆ–è€…ç›´æ¥åœ¨æ­¤è¾“å…¥éœ€è¦æŸ¥é‡çš„æ–‡æœ¬å†…å®¹..." style="display: none;"></textarea>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="startPlagiarismCheck()">ğŸ” å¼€å§‹æŸ¥é‡</button>
                <button class="btn btn-secondary" onclick="switchToTextInput()">ğŸ“ æ–‡æœ¬è¾“å…¥</button>
                <button class="btn btn-secondary" onclick="clearPlagiarismData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            </div>

            <div class="loading" id="plagiarismLoading">
                <div class="spinner"></div>
                <p>æ­£åœ¨è¿›è¡ŒæŸ¥é‡åˆ†æï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="plagiarism-report" id="plagiarismReport" style="display: none;">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">ğŸ“Š æŸ¥é‡åˆ†ææŠ¥å‘Š</h3>
                
                <div class="similarity-overview">
                    <div class="similarity-card">
                        <div class="similarity-percentage" id="totalSimilarity">0%</div>
                        <div class="similarity-label">æ€»ç›¸ä¼¼æ¯”</div>
                    </div>
                    <div class="similarity-card">
                        <div class="similarity-percentage" id="internetSimilarity">0%</div>
                        <div class="similarity-label">ç½‘ç»œç›¸ä¼¼æ¯”</div>
                    </div>
                    <div class="similarity-card">
                        <div class="similarity-percentage" id="paperSimilarity">0%</div>
                        <div class="similarity-label">è®ºæ–‡ç›¸ä¼¼æ¯”</div>
                    </div>
                    <div class="similarity-card">
                        <div class="similarity-percentage" id="selfCitation">0%</div>
                        <div class="similarity-label">è‡ªå¼•ç‡</div>
                    </div>
                </div>

                <div class="plagiarism-summary">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">æ£€æµ‹æ‘˜è¦</h4>
                    <div class="summary-item">
                        <span>æ£€æµ‹æ—¶é—´</span>
                        <span id="checkTime"></span>
                    </div>
                    <div class="summary-item">
                        <span>æ€»å­—æ•°</span>
                        <span id="totalWords"></span>
                    </div>
                    <div class="summary-item">
                        <span>é‡å¤å­—æ•°</span>
                        <span id="duplicateWords"></span>
                    </div>
                    <div class="summary-item">
                        <span>ç›¸ä¼¼ç‰‡æ®µæ•°</span>
                        <span id="similarSegments"></span>
                    </div>
                    <div class="summary-item">
                        <span>æ£€æµ‹æ¥æºæ•°</span>
                        <span id="sourcesCount"></span>
                    </div>
                </div>

                <div class="content-analysis">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ” è¯¦ç»†åˆ†æ</h4>
                    <div id="detailedAnalysis"></div>
                </div>

                <div class="reduction-suggestions">
                    <h4 style="margin-bottom: 15px; color: #2c3e50;">ğŸ’¡ é™é‡å»ºè®®</h4>
                    <div id="reductionSuggestions"></div>
                </div>
            </div>
        </div>

        <!-- æ™ºèƒ½é™é‡åŒºåŸŸ -->
        <div id="optimization" class="content-area">
            <div class="upload-mode-switch">
                <button class="mode-btn active" id="optimizationTextMode" onclick="switchOptimizationMode('text')">ğŸ“ æ–‡æœ¬è¾“å…¥</button>
                <button class="mode-btn" id="optimizationFileMode" onclick="switchOptimizationMode('file')">ğŸ“„ æ–‡æ¡£ä¸Šä¼ </button>
            </div>

            <div id="optimizationUploadArea" class="upload-area" style="display: none;" onclick="document.getElementById('optimizationFileInput').click()" 
                 ondrop="handleOptimizationFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ æ–‡æ¡£è¿›è¡Œæ™ºèƒ½é™é‡</div>
                <div class="upload-hint">æ”¯æŒ PDFã€DOCã€DOCXã€TXT æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
                <input type="file" id="optimizationFileInput" class="file-input" accept=".pdf,.doc,.docx,.txt" onchange="handleOptimizationFileSelect(event)">
            </div>

            <div class="upload-progress" id="optimizationUploadProgress">
                <div class="progress-container">
                    <div class="progress-bar-fill" id="optimizationProgressFill"></div>
                </div>
                <div class="progress-text" id="optimizationProgressText">ä¸Šä¼ ä¸­... 0%</div>
            </div>

            <div class="file-info" id="optimizationFileInfo" style="display: none;">
                <div class="file-name" id="optimizationFileName"></div>
                <div class="file-size" id="optimizationFileSize"></div>
            </div>

            <div class="file-preview" id="optimizationFilePreview">
                <div class="preview-header">æ–‡æ¡£å†…å®¹é¢„è§ˆï¼š</div>
                <div class="content-preview" id="optimizationPreviewContent"></div>
            </div>

            <textarea class="text-input" id="optimizationText" placeholder="è¯·åœ¨æ­¤è¾“å…¥éœ€è¦é™ä½AIç—•è¿¹çš„æ–‡æœ¬å†…å®¹..."></textarea>
            
            <div class="optimization-mode-selector" style="margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                    <label style="font-weight: 600; color: #2c3e50;">ä¼˜åŒ–æ¨¡å¼ï¼š</label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="optimizationMode" value="rule" checked style="margin-right: 5px;">
                        <span>ğŸ”§ è§„åˆ™ä¼˜åŒ–</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="optimizationMode" value="ai" style="margin-right: 5px;">
                        <span>ğŸ¤– AIä¼˜åŒ– (DeepSeek R1)</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="optimizationMode" value="hybrid" style="margin-right: 5px;">
                        <span>âš¡ æ··åˆä¼˜åŒ–</span>
                    </label>
                </div>
                <div id="aiModeNotice" style="display: none; background: #e3f2fd; padding: 10px; border-radius: 8px; font-size: 14px; color: #1976d2;">
                    <strong>ğŸ¤– AIæ¨¡å¼è¯´æ˜ï¼š</strong>ä½¿ç”¨æœ¬åœ°Ollama DeepSeek R1-8Bæ¨¡å‹è¿›è¡Œæ™ºèƒ½é™é‡ï¼Œéœ€è¦ç¡®ä¿OllamaæœåŠ¡è¿è¡Œåœ¨localhost:11434
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="optimizeText()">ğŸ¯ å¼€å§‹ä¼˜åŒ–</button>
                <button class="btn btn-secondary" onclick="clearOptimizationText()">ğŸ—‘ï¸ æ¸…ç©ºå†…å®¹</button>
                <button class="btn btn-secondary" onclick="copyOptimizedText()">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
                <button class="btn btn-secondary" onclick="testOllamaConnection()" id="testOllamaBtn">ğŸ” æµ‹è¯•AIè¿æ¥</button>
            </div>

            <div class="loading" id="optimizationLoading">
                <div class="spinner"></div>
                <p>æ­£åœ¨æ™ºèƒ½æ”¹å†™æ–‡æœ¬ï¼Œè¯·ç¨å€™...</p>
            </div>

            <div class="result-panel" id="optimizationResult" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #2c3e50;">âœ¨ ä¼˜åŒ–åçš„æ–‡æœ¬</h3>
                <div class="optimized-text" id="optimizedTextContent"></div>
                
                <div class="suggestions">
                    <h3 style="margin-bottom: 15px; color: #2c3e50;">ğŸ’¡ ä¼˜åŒ–å»ºè®®</h3>
                    <div id="optimizationSuggestions"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å¿…è¦çš„åº“æ¥è§£ææ–‡æ¡£ -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.4.2/mammoth.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let currentTab = 'detection';
        let detectionUploadedFile = null;
        let detectionDocumentText = '';
        let optimizationUploadedFile = null;
        let optimizationDocumentText = '';
        let uploadedFile = null;
        let currentDocumentText = '';

        // æ ‡ç­¾åˆ‡æ¢åŠŸèƒ½
        function switchTab(tabName) {
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // åˆ‡æ¢å†…å®¹åŒºåŸŸ
            document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            currentTab = tabName;
        }

        // AIGCæ£€æµ‹åŠŸèƒ½
        function analyzeText() {
            const text = document.getElementById('detectionText').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬å†…å®¹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('detectionLoading').style.display = 'block';
            document.getElementById('detectionResult').style.display = 'none';

            // æ¨¡æ‹Ÿåˆ†æå»¶æ—¶
            setTimeout(() => {
                const analysis = performAIGCAnalysis(text);
                displayAnalysisResult(analysis);
                
                document.getElementById('detectionLoading').style.display = 'none';
                document.getElementById('detectionResult').style.display = 'block';
            }, 2000);
        }

        // æ‰§è¡ŒAIGCåˆ†æï¼ˆå¢å¼ºç‰ˆ - æ”¯æŒæ–‡æœ¬æ ‡æ³¨ï¼‰
        function performAIGCAnalysis(text) {
            // åŸºç¡€ç»Ÿè®¡
            const wordCount = text.length;
            const sentences = text.split(/[ã€‚ï¼ï¼Ÿ.!?]+/).filter(s => s.trim().length > 0);
            const sentenceCount = sentences.length;
            const avgSentenceLength = Math.round(wordCount / sentenceCount);

            // AIç‰¹å¾æ£€æµ‹ç®—æ³•
            let aiScore = 0;
            let detectedIssues = []; // ç”¨äºè®°å½•å…·ä½“çš„AIç‰¹å¾ä½ç½®

            // 1. å¥å­é•¿åº¦ä¸€è‡´æ€§æ£€æµ‹
            const sentenceLengths = sentences.map(s => s.trim().length);
            const lengthVariation = calculateVariation(sentenceLengths);
            const structureScore = Math.max(0, 100 - lengthVariation * 2);
            
            // æ£€æµ‹å¥å­é•¿åº¦è¿‡äºä¸€è‡´çš„ç‰‡æ®µ
            if (lengthVariation < 25) {
                const avgLength = sentenceLengths.reduce((a, b) => a + b, 0) / sentenceLengths.length;
                sentences.forEach((sentence, index) => {
                    const trimmed = sentence.trim();
                    if (trimmed.length > 0 && Math.abs(trimmed.length - avgLength) < 5) {
                        detectedIssues.push({
                            type: 'structure',
                            text: trimmed,
                            reason: 'å¥å­é•¿åº¦è¿‡äºä¸€è‡´ï¼Œç¼ºä¹è‡ªç„¶å˜åŒ–',
                            severity: 'medium',
                            score: structureScore,
                            position: index + 1
                        });
                    }
                });
            }
            
            // 2. è¯æ±‡é‡å¤æ£€æµ‹
            const words = text.match(/[\u4e00-\u9fa5a-zA-Z]+/g) || [];
            const uniqueWords = new Set(words);
            const repetitionScore = Math.max(0, 100 - (uniqueWords.size / words.length) * 100);
            
            // æ£€æµ‹é‡å¤è¯æ±‡ä½¿ç”¨è¿‡å¤šçš„æƒ…å†µ
            const wordFreq = {};
            words.forEach(word => {
                wordFreq[word] = (wordFreq[word] || 0) + 1;
            });
            
            for (const [word, freq] of Object.entries(wordFreq)) {
                if (freq > 3 && word.length > 1) {
                    // æ‰¾å‡ºåŒ…å«è¯¥è¯çš„å¥å­
                    const containingSentences = sentences.filter(s => s.includes(word));
                    detectedIssues.push({
                        type: 'repetition',
                        text: word,
                        reason: `è¯æ±‡"${word}"é‡å¤ä½¿ç”¨${freq}æ¬¡ï¼Œè¯æ±‡é€‰æ‹©å•ä¸€`,
                        severity: freq > 5 ? 'high' : 'medium',
                        score: Math.min(100, freq * 10),
                        examples: containingSentences.slice(0, 3)
                    });
                }
            }

            // 3. æµç•…åº¦æ£€æµ‹ (åŸºäºå¸¸è§AIç”¨è¯)
            const aiWords = ['æ˜¾è‘—', 'é‡è¦', 'å…³é”®', 'æœ‰æ•ˆ', 'æˆåŠŸ', 'å®Œå–„', 'ä¼˜åŒ–', 'æå‡', 'å®ç°', 'ç¡®ä¿', 'è¿›ä¸€æ­¥', 'æ·±å…¥', 'å…¨é¢', 'ç»¼åˆ', 'ç³»ç»Ÿ'];
            let aiWordCount = 0;
            
            aiWords.forEach(word => {
                const regex = new RegExp(word, 'g');
                const matches = text.match(regex);
                if (matches) {
                    aiWordCount += matches.length;
                    // æ‰¾å‡ºåŒ…å«è¯¥AIè¯æ±‡çš„å¥å­
                    const containingSentences = sentences.filter(s => s.includes(word));
                    detectedIssues.push({
                        type: 'aiWords',
                        text: word,
                        reason: `"${word}"æ˜¯AIå¸¸ç”¨è¯æ±‡ï¼Œå‡ºç°${matches.length}æ¬¡`,
                        severity: matches.length > 2 ? 'high' : 'medium',
                        score: matches.length * 15,
                        examples: containingSentences.slice(0, 2)
                    });
                }
            });
            
            const fluencyScore = Math.min(100, aiWordCount * 15);

            // 4. æƒ…æ„Ÿè¡¨è¾¾æ£€æµ‹
            const emotionWords = ['æˆ‘è§‰å¾—', 'æ„Ÿè§‰', 'è®¤ä¸º', 'ä¸ªäºº', 'ä½“éªŒ', 'æ„Ÿå—', 'æƒ³æ³•', 'è§‚ç‚¹', 'æˆ‘è®¤ä¸º', 'æˆ‘çš„çœ‹æ³•'];
            const emotionWordCount = emotionWords.reduce((count, word) => count + (text.includes(word) ? 1 : 0), 0);
            const emotionScore = Math.max(0, 100 - emotionWordCount * 20);
            
            // æ£€æµ‹ç¼ºä¹ä¸ªäººåŒ–è¡¨è¾¾çš„æ®µè½
            const paragraphs = text.split(/\n+/).filter(p => p.trim().length > 50);
            paragraphs.forEach((paragraph, index) => {
                const hasEmotion = emotionWords.some(word => paragraph.includes(word));
                if (!hasEmotion && paragraph.length > 100) {
                    detectedIssues.push({
                        type: 'emotion',
                        text: paragraph.substring(0, 100) + '...',
                        reason: 'ç¼ºä¹ä¸ªäººåŒ–è¡¨è¾¾å’Œä¸»è§‚è‰²å½©',
                        severity: 'medium',
                        score: 30,
                        position: `ç¬¬${index + 1}æ®µ`
                    });
                }
            });

            // è®¡ç®—ç»¼åˆAIæ¦‚ç‡
            aiScore = Math.round((structureScore + repetitionScore + fluencyScore + emotionScore) / 4);

            // è¯æ±‡ä¸°å¯Œåº¦
            const vocabularyRichness = Math.round((uniqueWords.size / words.length) * 100);

            return {
                aiProbability: aiScore,
                structureScore,
                repetitionScore,
                fluencyScore,
                emotionScore,
                wordCount,
                sentenceCount,
                avgSentenceLength,
                vocabularyRichness,
                detectedIssues // æ–°å¢ï¼šå…·ä½“æ£€æµ‹åˆ°çš„é—®é¢˜
            };
        }

        // è®¡ç®—å˜å¼‚ç³»æ•°
        function calculateVariation(values) {
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            const stdDev = Math.sqrt(variance);
            return (stdDev / mean) * 100;
        }

        // æ˜¾ç¤ºåˆ†æç»“æœï¼ˆå¢å¼ºç‰ˆ - åŒ…å«å…·ä½“é—®é¢˜æ ‡æ³¨ï¼‰
        function displayAnalysisResult(analysis) {
            // AIæ¦‚ç‡å’Œé£é™©ç­‰çº§
            document.getElementById('aiProbability').textContent = analysis.aiProbability + '%';
            
            const riskLevel = document.getElementById('riskLevel');
            if (analysis.aiProbability >= 70) {
                riskLevel.textContent = 'é«˜é£é™©';
                riskLevel.className = 'risk-level risk-high';
            } else if (analysis.aiProbability >= 40) {
                riskLevel.textContent = 'ä¸­é£é™©';
                riskLevel.className = 'risk-level risk-medium';
            } else {
                riskLevel.textContent = 'ä½é£é™©';
                riskLevel.className = 'risk-level risk-low';
            }

            // è¯¦ç»†åˆ†æè¿›åº¦æ¡
            document.getElementById('structureScore').style.width = analysis.structureScore + '%';
            document.getElementById('repetitionScore').style.width = analysis.repetitionScore + '%';
            document.getElementById('fluencyScore').style.width = analysis.fluencyScore + '%';
            document.getElementById('emotionScore').style.width = analysis.emotionScore + '%';

            // ç»Ÿè®¡ä¿¡æ¯
            document.getElementById('wordCount').textContent = analysis.wordCount;
            document.getElementById('sentenceCount').textContent = analysis.sentenceCount;
            document.getElementById('avgSentenceLength').textContent = analysis.avgSentenceLength;
            document.getElementById('vocabularyRichness').textContent = analysis.vocabularyRichness + '%';
            
            // æ˜¾ç¤ºå…·ä½“æ£€æµ‹åˆ°çš„é—®é¢˜
            displayDetectedIssues(analysis.detectedIssues);
        }
        
        // æ˜¾ç¤ºå…·ä½“æ£€æµ‹åˆ°çš„AIç‰¹å¾é—®é¢˜
        function displayDetectedIssues(issues) {
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨issueså®¹å™¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»º
            let issuesContainer = document.getElementById('detectedIssuesContainer');
            if (!issuesContainer) {
                issuesContainer = document.createElement('div');
                issuesContainer.id = 'detectedIssuesContainer';
                issuesContainer.innerHTML = '<h4 style="margin: 20px 0 15px 0; color: #2c3e50;">ğŸ” å…·ä½“AIç‰¹å¾æ£€æµ‹</h4>';
                
                // æ’å…¥åˆ°ç»“æœé¢æ¿ä¸­
                const resultPanel = document.getElementById('detectionResult');
                resultPanel.appendChild(issuesContainer);
            }
            
            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹ï¼Œä¿ç•™æ ‡é¢˜
            const title = issuesContainer.querySelector('h4');
            issuesContainer.innerHTML = '';
            issuesContainer.appendChild(title);
            
            if (issues.length === 0) {
                issuesContainer.innerHTML += '<div style="color: #38a169; padding: 15px; background: #f0fff4; border-radius: 8px; margin: 10px 0;">âœ… æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„AIç”Ÿæˆç‰¹å¾</div>';
                return;
            }
            
            // æŒ‰ä¸¥é‡ç¨‹åº¦åˆ†ç»„æ˜¾ç¤º
            const groupedIssues = {
                high: issues.filter(issue => issue.severity === 'high'),
                medium: issues.filter(issue => issue.severity === 'medium'),
                low: issues.filter(issue => issue.severity === 'low')
            };
            
            // æ˜¾ç¤ºé«˜é£é™©é—®é¢˜
            if (groupedIssues.high.length > 0) {
                const highSection = document.createElement('div');
                highSection.innerHTML = '<h5 style="color: #c53030; margin: 15px 0 10px 0;">ğŸš¨ é«˜é£é™©ç‰¹å¾</h5>';
                groupedIssues.high.forEach(issue => {
                    highSection.appendChild(createIssueElement(issue, 'high'));
                });
                issuesContainer.appendChild(highSection);
            }
            
            // æ˜¾ç¤ºä¸­é£é™©é—®é¢˜
            if (groupedIssues.medium.length > 0) {
                const mediumSection = document.createElement('div');
                mediumSection.innerHTML = '<h5 style="color: #dd6b20; margin: 15px 0 10px 0;">âš ï¸ ä¸­é£é™©ç‰¹å¾</h5>';
                groupedIssues.medium.forEach(issue => {
                    mediumSection.appendChild(createIssueElement(issue, 'medium'));
                });
                issuesContainer.appendChild(mediumSection);
            }
            
            // æ˜¾ç¤ºä½é£é™©é—®é¢˜
            if (groupedIssues.low.length > 0) {
                const lowSection = document.createElement('div');
                lowSection.innerHTML = '<h5 style="color: #38a169; margin: 15px 0 10px 0;">ğŸ’¡ è½»å¾®ç‰¹å¾</h5>';
                groupedIssues.low.forEach(issue => {
                    lowSection.appendChild(createIssueElement(issue, 'low'));
                });
                issuesContainer.appendChild(lowSection);
            }
        }
        
        // åˆ›å»ºé—®é¢˜æ˜¾ç¤ºå…ƒç´ 
        function createIssueElement(issue, severity) {
            const element = document.createElement('div');
            element.className = `issue-item issue-${severity}`;
            
            const severityColors = {
                high: { bg: '#fee', border: '#c53030', text: '#c53030' },
                medium: { bg: '#fffaf0', border: '#dd6b20', text: '#dd6b20' },
                low: { bg: '#f0fff4', border: '#38a169', text: '#38a169' }
            };
            
            const color = severityColors[severity];
            
            element.style.cssText = `
                background: ${color.bg};
                border-left: 4px solid ${color.border};
                padding: 12px 15px;
                margin: 8px 0;
                border-radius: 6px;
                font-size: 14px;
            `;
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <strong style="color: ${color.text};">${getTypeLabel(issue.type)}</strong>
                    <span style="background: ${color.border}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                        ${issue.score}åˆ†
                    </span>
                </div>
                <div style="color: #2d3748; margin-bottom: 6px;">${issue.reason}</div>
            `;
            
            if (issue.text) {
                html += `<div style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; font-style: italic; color: #4a5568;">
                    "${issue.text}"
                </div>`;
            }
            
            if (issue.examples && issue.examples.length > 0) {
                html += '<div style="margin-top: 8px; font-size: 13px; color: #4a5568;">ç›¸å…³å¥å­ï¼š</div>';
                issue.examples.forEach(example => {
                    html += `<div style="background: rgba(0,0,0,0.05); padding: 6px; margin: 4px 0; border-radius: 4px; font-size: 13px;">
                        "${example.trim()}"
                    </div>`;
                });
            }
            
            if (issue.position) {
                html += `<div style="margin-top: 6px; font-size: 12px; color: #718096;">ä½ç½®ï¼š${issue.position}</div>`;
            }
            
            element.innerHTML = html;
            return element;
        }
        
        // è·å–é—®é¢˜ç±»å‹æ ‡ç­¾
        function getTypeLabel(type) {
            const labels = {
                structure: 'å¥å¼ç»“æ„',
                repetition: 'è¯æ±‡é‡å¤',
                aiWords: 'AIç”¨è¯',
                emotion: 'æƒ…æ„Ÿè¡¨è¾¾'
            };
            return labels[type] || type;
        }

        // æ™ºèƒ½é™é‡åŠŸèƒ½
        function optimizeText() {
            const text = document.getElementById('optimizationText').value.trim();
            if (!text) {
                alert('è¯·è¾“å…¥éœ€è¦é™é‡çš„æ–‡æœ¬å†…å®¹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('optimizationLoading').style.display = 'block';
            document.getElementById('optimizationResult').style.display = 'none';

            // æ¨¡æ‹Ÿä¼˜åŒ–å»¶æ—¶
            setTimeout(() => {
                const optimizedData = performTextOptimization(text);
                displayOptimizationResult(optimizedData);
                
                document.getElementById('optimizationLoading').style.display = 'none';
                document.getElementById('optimizationResult').style.display = 'block';
            }, 3000);
        }

        // æ‰§è¡Œæ–‡æœ¬ä¼˜åŒ–ï¼ˆåŸºäºAIGCåˆ†æç»“æœï¼‰
        function performTextOptimization(text) {
            let optimizedText = text;
            const suggestions = [];
            const modifications = []; // è®°å½•å…·ä½“çš„ä¿®æ”¹å†…å®¹

            // é¦–å…ˆè¿›è¡ŒAIGCåˆ†æï¼Œè·å–å…·ä½“é—®é¢˜
            const aigcAnalysis = performAIGCAnalysis(text);
            const detectedIssues = aigcAnalysis.detectedIssues || [];
            
            // è®°å½•åˆå§‹AIGCåˆ†æç»“æœ
            suggestions.push({
                title: 'AIGCæ£€æµ‹åˆ†æ',
                text: `åˆå§‹AIç”Ÿæˆæ¦‚ç‡ï¼š${aigcAnalysis.aiProbability}%ï¼Œæ£€æµ‹åˆ°${detectedIssues.length}ä¸ªæ½œåœ¨é—®é¢˜`
            });

            // 1. åŸºäºæ£€æµ‹é—®é¢˜è¿›è¡Œé’ˆå¯¹æ€§çš„åŒä¹‰è¯æ›¿æ¢
            const advancedSynonymMap = {
                'æ˜¾è‘—': ['æ˜æ˜¾', 'çªå‡º', 'æ¸…æ¥š', 'é²œæ˜'],
                'é‡è¦': ['å…³é”®', 'æ ¸å¿ƒ', 'ä¸»è¦', 'é‡ç‚¹'],
                'æœ‰æ•ˆ': ['ç®¡ç”¨', 'å¥½ç”¨', 'å®ç”¨', 'æœ‰ç”¨'],
                'å®ç°': ['è¾¾åˆ°', 'å®Œæˆ', 'åšåˆ°', 'å–å¾—'],
                'æå‡': ['æ”¹å–„', 'å¢å¼º', 'åŠ å¼º', 'æé«˜'],
                'ç¡®ä¿': ['ä¿è¯', 'ä¿éšœ', 'ç¡®è®¤', 'è®©'],
                'ä¼˜åŒ–': ['æ”¹è¿›', 'æ”¹å–„', 'å®Œå–„', 'è°ƒæ•´'],
                'å®Œå–„': ['æ”¹è¿›', 'å¥å…¨', 'å……å®', 'æ”¹å–„'],
                'æˆåŠŸ': ['é¡ºåˆ©', 'æœ‰æ•ˆ', 'åœ†æ»¡', 'è‰¯å¥½'],
                'å…³é”®': ['æ ¸å¿ƒ', 'ä¸»è¦', 'é‡ç‚¹', 'è¦å®³'],
                'è¿›ä¸€æ­¥': ['æ›´åŠ ', 'è¿›è€Œ', 'æ¥ç€', 'ç»§ç»­'],
                'æ·±å…¥': ['è¯¦ç»†', 'ä»”ç»†', 'æ·±åˆ»', 'é€å½»'],
                'å…¨é¢': ['å®Œæ•´', 'è¯¦å°½', 'å‘¨å…¨', 'å½»åº•'],
                'ç»¼åˆ': ['æ•´ä½“', 'æ€»ä½“', 'å…¨æ–¹ä½', 'ç»Ÿä¸€'],
                'ç³»ç»Ÿ': ['å®Œæ•´', 'å…¨å¥—', 'æ•´ä½“', 'ç»Ÿä¸€']
            };

            // é’ˆå¯¹æ£€æµ‹åˆ°çš„AIè¯æ±‡é—®é¢˜è¿›è¡Œæ›¿æ¢
            let aiWordIssues = detectedIssues.filter(issue => issue.type === 'aiWords');
            if (aiWordIssues.length > 0) {
                Object.keys(advancedSynonymMap).forEach(word => {
                    const regex = new RegExp(word, 'g');
                    const matches = optimizedText.match(regex);
                    if (matches) {
                        const synonyms = advancedSynonymMap[word];
                        const replacement = synonyms[Math.floor(Math.random() * synonyms.length)];
                        
                        // è®°å½•æ›¿æ¢å‰çš„å¥å­
                        const sentencesWithWord = optimizedText.split(/[ã€‚ï¼ï¼Ÿ.!?]+/).filter(s => s.includes(word));
                        
                        optimizedText = optimizedText.replace(regex, replacement);
                        
                        sentencesWithWord.forEach(sentence => {
                            if (sentence.trim()) {
                                modifications.push({
                                    type: 'synonym',
                                    original: sentence.trim(),
                                    modified: sentence.replace(new RegExp(word, 'g'), replacement).trim(),
                                    reason: `é’ˆå¯¹AIç”¨è¯é—®é¢˜ï¼š${word} â†’ ${replacement}`
                                });
                            }
                        });
                        
                        suggestions.push({
                            title: 'AIè¯æ±‡æ›¿æ¢',
                            text: `å°†AIå¸¸ç”¨è¯"${word}"æ›¿æ¢ä¸º"${replacement}"ï¼Œé™ä½æœºå™¨åŒ–ç‰¹å¾ï¼ˆ${matches.length}å¤„ï¼‰`
                        });
                    }
                });
            }

            // 2. é’ˆå¯¹å¥å­ç»“æ„é—®é¢˜è¿›è¡Œè°ƒæ•´
            let structureIssues = detectedIssues.filter(issue => issue.type === 'structure');
            if (structureIssues.length > 0) {
                suggestions.push({
                    title: 'å¥å­ç»“æ„ä¼˜åŒ–',
                    text: `æ£€æµ‹åˆ°${structureIssues.length}ä¸ªå¥å­ç»“æ„é—®é¢˜ï¼Œè¿›è¡Œé’ˆå¯¹æ€§è°ƒæ•´`
                });
                
                // è°ƒæ•´å¥å­é•¿åº¦è¿‡äºä¸€è‡´çš„é—®é¢˜
                const sentences = optimizedText.split(/[ã€‚ï¼ï¼Ÿ.!?]+/).filter(s => s.trim().length > 0);
                for (let i = 0; i < sentences.length; i++) {
                    let sentence = sentences[i].trim();
                    if (sentence.length > 40 && (sentence.includes('ï¼Œ') || sentence.includes('ï¼›'))) {
                        // æ‹†åˆ†é•¿å¥
                        const parts = sentence.split(/[ï¼Œï¼›]/);
                        if (parts.length >= 2) {
                            const newSentence = parts[0].trim() + 'ã€‚å¦å¤–ï¼Œ' + parts.slice(1).join('ï¼Œ').trim();
                            optimizedText = optimizedText.replace(sentence, newSentence);
                            
                            modifications.push({
                                type: 'structure',
                                original: sentence,
                                modified: newSentence,
                                reason: 'æ‹†åˆ†è¿‡é•¿å¥å­ï¼Œæ”¹å–„å¥å¼å•ä¸€é—®é¢˜'
                            });
                        }
                    }
                }
            }

            // 3. è¢«åŠ¨è¯­æ€è½¬ä¸»åŠ¨è¯­æ€
            const passivePattern = /(\S+)è¢«(\S+)/g;
            let passiveMatches = [];
            let match;
            while ((match = passivePattern.exec(text)) !== null) {
                passiveMatches.push(match);
            }
            
            if (passiveMatches.length > 0) {
                passiveMatches.forEach(match => {
                    const original = match[0];
                    const subject = match[1];
                    const verb = match[2];
                    const active = `${verb}äº†${subject}`;
                    
                    // æ‰¾åˆ°åŒ…å«è¯¥è¢«åŠ¨è¯­æ€çš„å¥å­
                    const sentenceWithPassive = optimizedText.split(/[ã€‚ï¼ï¼Ÿ.!?]+/).find(s => s.includes(original));
                    if (sentenceWithPassive) {
                        const modifiedSentence = sentenceWithPassive.replace(original, active);
                        optimizedText = optimizedText.replace(sentenceWithPassive, modifiedSentence);
                        
                        modifications.push({
                            type: 'sentence',
                            original: sentenceWithPassive.trim(),
                            modified: modifiedSentence.trim(),
                            reason: `è¢«åŠ¨è¯­æ€è½¬ä¸»åŠ¨è¯­æ€ï¼Œå¢åŠ è¯­è¨€æ´»åŠ›`
                        });
                    }
                });
                
                suggestions.push({
                    title: 'è¯­æ€è°ƒæ•´',
                    text: `è°ƒæ•´äº†${passiveMatches.length}å¤„è¢«åŠ¨è¯­æ€ä¸ºä¸»åŠ¨è¯­æ€ï¼Œæå‡è¡¨è¾¾è‡ªç„¶åº¦`
                });
            }

            // 4. é’ˆå¯¹æƒ…æ„Ÿè¡¨è¾¾é—®é¢˜å¢åŠ ä¸ªäººåŒ–å†…å®¹
            let emotionIssues = detectedIssues.filter(issue => issue.type === 'emotion');
            if (emotionIssues.length > 0) {
                const personalExpressions = [
                    'ä»æˆ‘çš„è§‚å¯Ÿæ¥çœ‹', 'ä¸ªäººè®¤ä¸º', 'æˆ‘è§‰å¾—', 'æ®æˆ‘çš„ç»éªŒ', 
                    'åœ¨æˆ‘çœ‹æ¥', 'æˆ‘å‘ç°', 'æˆ‘æ³¨æ„åˆ°', 'ä»æˆ‘çš„è§’åº¦'
                ];
                const sentences = optimizedText.split('ã€‚').filter(s => s.trim().length > 10);
                
                if (sentences.length > 1) {
                    // é€‰æ‹©ä¸€ä¸ªé€‚åˆæ·»åŠ ä¸ªäººè¡¨è¾¾çš„å¥å­
                    const targetIndex = Math.floor(sentences.length / 3);
                    const originalSentence = sentences[targetIndex].trim();
                    const randomExpression = personalExpressions[Math.floor(Math.random() * personalExpressions.length)];
                    
                    // æ£€æŸ¥å¥å­æ˜¯å¦å·²ç»æœ‰ä¸ªäººåŒ–è¡¨è¾¾
                    const hasPersonalExpression = personalExpressions.some(expr => originalSentence.includes(expr.substring(0, 2)));
                    
                    if (!hasPersonalExpression) {
                        sentences[targetIndex] = randomExpression + 'ï¼Œ' + originalSentence.toLowerCase();
                        optimizedText = sentences.join('ã€‚');
                        
                        modifications.push({
                            type: 'personal',
                            original: originalSentence,
                            modified: sentences[targetIndex],
                            reason: `é’ˆå¯¹ç¼ºä¹æƒ…æ„Ÿè¡¨è¾¾é—®é¢˜ï¼Œå¢åŠ ä¸ªäººè§‚ç‚¹`
                        });
                        
                        suggestions.push({
                            title: 'ä¸ªäººåŒ–è¡¨è¾¾å¢å¼º',
                            text: `é’ˆå¯¹${emotionIssues.length}ä¸ªç¼ºä¹ä¸ªäººè‰²å½©çš„æ®µè½ï¼Œæ·»åŠ "${randomExpression}"ç­‰ä¸»è§‚è¡¨è¾¾`
                        });
                    }
                }
            }

            // 4. å¥å­ç»“æ„å¤šæ ·åŒ–
            const longSentences = optimizedText.split('ã€‚').filter(s => s.trim().length > 40);
            let restructuredCount = 0;
            
            longSentences.forEach(sentence => {
                if (sentence.includes('ï¼Œ') && Math.random() > 0.5) {
                    const parts = sentence.split('ï¼Œ');
                    if (parts.length >= 2) {
                        const restructured = parts[1].trim() + 'ï¼Œ' + parts[0].trim() + (parts.slice(2).length > 0 ? 'ï¼Œ' + parts.slice(2).join('ï¼Œ') : '');
                        optimizedText = optimizedText.replace(sentence, restructured);
                        
                        modifications.push({
                            type: 'structure',
                            original: sentence.trim(),
                            modified: restructured.trim(),
                            reason: 'å¥å­ç»“æ„è°ƒæ•´ï¼šæ”¹å˜åˆ†å¥é¡ºåº'
                        });
                        
                        restructuredCount++;
                    }
                }
            });
            
            if (restructuredCount > 0) {
                suggestions.push({
                    title: 'å¥å­ç»“æ„ä¼˜åŒ–',
                    text: `è°ƒæ•´äº†${restructuredCount}ä¸ªé•¿å¥çš„ç»“æ„ï¼Œå¢åŠ å¥å¼å˜åŒ–`
                });
            }

            // 5. æ ‡ç‚¹ç¬¦å·å¾®è°ƒ
            const originalCommas = (optimizedText.match(/ï¼Œ/g) || []).length;
            optimizedText = optimizedText.replace(/ï¼Œ([^ï¼Œ]{10,}?)ï¼Œ/g, (match, middle) => {
                return Math.random() > 0.7 ? `ï¼Œ${middle}ï¼›` : match; // 30%æ¦‚ç‡å°†é€—å·æ”¹ä¸ºåˆ†å·
            });
            
            const newCommas = (optimizedText.match(/ï¼Œ/g) || []).length;
            if (newCommas !== originalCommas) {
                suggestions.push({
                    title: 'æ ‡ç‚¹ç¬¦å·ä¼˜åŒ–',
                    text: 'è°ƒæ•´äº†éƒ¨åˆ†æ ‡ç‚¹ç¬¦å·ä½¿ç”¨ï¼Œæ¨¡æ‹Ÿè‡ªç„¶ä¹¦å†™ä¹ æƒ¯'
                });
            }

            // æœ€ç»ˆä¼˜åŒ–æ•ˆæœè¯„ä¼°
            const finalAigcAnalysis = performAIGCAnalysis(optimizedText);
            const improvementPercent = Math.max(0, aigcAnalysis.aiProbability - finalAigcAnalysis.aiProbability);
            
            if (improvementPercent > 0) {
                suggestions.push({
                    title: 'ä¼˜åŒ–æ•ˆæœè¯„ä¼°',
                    text: `AIç”Ÿæˆæ¦‚ç‡ä»${aigcAnalysis.aiProbability}%é™ä½åˆ°${finalAigcAnalysis.aiProbability}%ï¼Œæ”¹å–„äº†${improvementPercent.toFixed(1)}ä¸ªç™¾åˆ†ç‚¹`
                });
            }

            return {
                originalText: text,
                optimizedText,
                suggestions,
                modifications, // å…·ä½“çš„ä¿®æ”¹è®°å½•
                originalAigcScore: aigcAnalysis.aiProbability,
                finalAigcScore: finalAigcAnalysis.aiProbability,
                improvement: improvementPercent
            };
        }

        // æ˜¾ç¤ºä¼˜åŒ–ç»“æœï¼ˆåŸºäºAIGCæ”¹å–„æ•ˆæœï¼‰
        function displayOptimizationResult(data) {
            document.getElementById('optimizedTextContent').textContent = data.optimizedText;
            
            const suggestionsContainer = document.getElementById('optimizationSuggestions');
            suggestionsContainer.innerHTML = '';
            
            // æ·»åŠ AIGCæ”¹å–„æ•ˆæœæ¦‚è§ˆ
            if (data.improvement !== undefined) {
                const improvementElement = document.createElement('div');
                improvementElement.className = 'suggestion-item';
                
                // æ ¹æ®ä¼˜åŒ–æ¨¡å¼è®¾ç½®ä¸åŒçš„èƒŒæ™¯é¢œè‰²
                let modeIcon = 'ğŸ”§';
                let modeColor = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                let modeLabel = 'è§„åˆ™ä¼˜åŒ–';
                
                if (data.mode === 'ai') {
                    modeIcon = 'ğŸ¤–';
                    modeColor = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                    modeLabel = 'AIä¼˜åŒ– (DeepSeek R1)';
                } else if (data.mode === 'hybrid') {
                    modeIcon = 'âš¡';
                    modeColor = 'linear-gradient(135deg, #ff9a56 0%, #ff6a95 100%)';
                    modeLabel = 'æ··åˆä¼˜åŒ– (è§„åˆ™+AI)';
                }
                
                improvementElement.style.cssText = `background: ${modeColor}; color: white; border-left: none;`;
                
                const improvementIcon = data.improvement > 10 ? 'ğŸ‰' : (data.improvement > 5 ? 'âœ…' : 'ğŸ“ˆ');
                
                improvementElement.innerHTML = `
                    <h5 style="color: white; margin-bottom: 8px;">${modeIcon} ${modeLabel}æ•ˆæœ</h5>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span>ä¼˜åŒ–å‰ AI æ¦‚ç‡ï¼š</span><strong>${data.originalAigcScore}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span>ä¼˜åŒ–å AI æ¦‚ç‡ï¼š</span><strong>${data.finalAigcScore}%</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>æ”¹å–„ç¨‹åº¦ï¼š</span><strong style="color: #90EE90;">${improvementIcon} -${data.improvement.toFixed(1)}%</strong>
                    </div>
                `;
                suggestionsContainer.appendChild(improvementElement);
            }
            
            // æ˜¾ç¤ºä¼˜åŒ–å»ºè®®
            data.suggestions.forEach(suggestion => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'suggestion-item';
                
                // æ ¹æ®å»ºè®®ç±»å‹è®¾ç½®ä¸åŒçš„å›¾æ ‡
                let icon = 'ğŸ’¡';
                if (suggestion.title.includes('AIGCæ£€æµ‹')) icon = 'ğŸ”';
                else if (suggestion.title.includes('AIè¯æ±‡')) icon = 'ğŸ“';
                else if (suggestion.title.includes('ç»“æ„')) icon = 'ğŸ”§';
                else if (suggestion.title.includes('ä¸ªäººåŒ–')) icon = 'ğŸ—£ï¸';
                else if (suggestion.title.includes('æ•ˆæœ')) icon = 'ğŸ“Š';
                
                suggestionElement.innerHTML = `
                    <h5 style="color: #2c3e50; margin-bottom: 8px;">${icon} ${suggestion.title}</h5>
                    <p style="color: #5a6c7d; margin: 0;">${suggestion.text}</p>
                `;
                suggestionsContainer.appendChild(suggestionElement);
            });
            
            // æ˜¾ç¤ºå…·ä½“ä¿®æ”¹å¯¹æ¯”
            if (data.modifications && data.modifications.length > 0) {
                displayModificationComparison(data.modifications);
            }
        }
        
        // æ˜¾ç¤ºä¿®æ”¹å¯¹æ¯”è¯¦æƒ…
        function displayModificationComparison(modifications) {
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¿®æ”¹å¯¹æ¯”å®¹å™¨ï¼Œå¦‚æœä¸å­˜åœ¨å°±åˆ›å»º
            let comparisonContainer = document.getElementById('modificationComparisonContainer');
            if (!comparisonContainer) {
                comparisonContainer = document.createElement('div');
                comparisonContainer.id = 'modificationComparisonContainer';
                
                // æ’å…¥åˆ°ä¼˜åŒ–ç»“æœé¢æ¿ä¸­
                const resultPanel = document.getElementById('optimizationResult');
                resultPanel.appendChild(comparisonContainer);
            }
            
            comparisonContainer.innerHTML = '<h3 style="margin: 25px 0 15px 0; color: #2c3e50;">ğŸ” å…·ä½“ä¿®æ”¹å¯¹æ¯”</h3>';
            
            if (modifications.length === 0) {
                comparisonContainer.innerHTML += '<div style="color: #38a169; padding: 15px; background: #f0fff4; border-radius: 8px; margin: 10px 0;">âœ… æ–‡æœ¬å·²ç»å¾ˆè‡ªç„¶ï¼Œæœªåšå¤§å¹…ä¿®æ”¹</div>';
                return;
            }
            
            // æŒ‰ä¿®æ”¹ç±»å‹åˆ†ç»„æ˜¾ç¤º
            const groupedModifications = {
                synonym: modifications.filter(mod => mod.type === 'synonym'),
                sentence: modifications.filter(mod => mod.type === 'sentence'),
                personal: modifications.filter(mod => mod.type === 'personal'),
                structure: modifications.filter(mod => mod.type === 'structure'),
                punctuation: modifications.filter(mod => mod.type === 'punctuation')
            };
            
            // æ˜¾ç¤ºåŒä¹‰è¯æ›¿æ¢
            if (groupedModifications.synonym.length > 0) {
                const synonymSection = document.createElement('div');
                synonymSection.innerHTML = '<h4 style="color: #667eea; margin: 20px 0 10px 0;">ğŸ“ åŒä¹‰è¯æ›¿æ¢</h4>';
                groupedModifications.synonym.forEach(mod => {
                    synonymSection.appendChild(createModificationElement(mod));
                });
                comparisonContainer.appendChild(synonymSection);
            }
            
            // æ˜¾ç¤ºå¥å¼è°ƒæ•´
            if (groupedModifications.sentence.length > 0) {
                const sentenceSection = document.createElement('div');
                sentenceSection.innerHTML = '<h4 style="color: #667eea; margin: 20px 0 10px 0;">ğŸ”„ å¥å¼è°ƒæ•´</h4>';
                groupedModifications.sentence.forEach(mod => {
                    sentenceSection.appendChild(createModificationElement(mod));
                });
                comparisonContainer.appendChild(sentenceSection);
            }
            
            // æ˜¾ç¤ºä¸ªäººåŒ–è¡¨è¾¾
            if (groupedModifications.personal.length > 0) {
                const personalSection = document.createElement('div');
                personalSection.innerHTML = '<h4 style="color: #667eea; margin: 20px 0 10px 0;">ğŸ—£ï¸ ä¸ªäººåŒ–è¡¨è¾¾</h4>';
                groupedModifications.personal.forEach(mod => {
                    personalSection.appendChild(createModificationElement(mod));
                });
                comparisonContainer.appendChild(personalSection);
            }
            
            // æ˜¾ç¤ºç»“æ„è°ƒæ•´
            if (groupedModifications.structure.length > 0) {
                const structureSection = document.createElement('div');
                structureSection.innerHTML = '<h4 style="color: #667eea; margin: 20px 0 10px 0;">ğŸ”§ ç»“æ„è°ƒæ•´</h4>';
                groupedModifications.structure.forEach(mod => {
                    structureSection.appendChild(createModificationElement(mod));
                });
                comparisonContainer.appendChild(structureSection);
            }
        }
        
        // åˆ›å»ºä¿®æ”¹å¯¹æ¯”å…ƒç´ 
        function createModificationElement(modification) {
            const element = document.createElement('div');
            element.style.cssText = `
                background: #f8f9fa;
                border: 1px solid #e9ecef;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                font-size: 14px;
            `;
            
            element.innerHTML = `
                <div style="margin-bottom: 12px; font-weight: 600; color: #495057;">
                    ${modification.reason}
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <div style="font-weight: 600; color: #dc3545; margin-bottom: 6px;">âŒ ä¿®æ”¹å‰ï¼š</div>
                        <div style="background: #fff5f5; border-left: 4px solid #dc3545; padding: 10px; border-radius: 4px; line-height: 1.5;">
                            "${modification.original}"
                        </div>
                    </div>
                    <div>
                        <div style="font-weight: 600; color: #28a745; margin-bottom: 6px;">âœ… ä¿®æ”¹åï¼š</div>
                        <div style="background: #f0fff4; border-left: 4px solid #28a745; padding: 10px; border-radius: 4px; line-height: 1.5;">
                            "${modification.modified}"
                        </div>
                    </div>
                </div>
            `;
            
            return element;
        }
        
        // åŸæœ‰çš„æ˜¾ç¤ºåŠŸèƒ½ä¿æŒä¸å˜ï¼ˆä¸ºäº†å…¼å®¹æ€§ï¼‰
        function displayOriginalOptimizationResult(data) {
            document.getElementById('optimizedTextContent').textContent = data.optimizedText;
            
            const suggestionsContainer = document.getElementById('optimizationSuggestions');
            suggestionsContainer.innerHTML = '';
            
            data.suggestions.forEach(suggestion => {
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'suggestion-item';
                suggestionElement.innerHTML = `
                    <div class="suggestion-title">${suggestion.title}</div>
                    <div class="suggestion-text">${suggestion.text}</div>
                `;
                suggestionsContainer.appendChild(suggestionElement);
            });

            if (data.suggestions.length === 0) {
                suggestionsContainer.innerHTML = '<div class="suggestion-item"><div class="suggestion-text">æ–‡æœ¬è´¨é‡è‰¯å¥½ï¼Œæš‚æ— ç‰¹æ®Šä¼˜åŒ–å»ºè®®</div></div>';
            }
        }

        // è¾…åŠ©åŠŸèƒ½
        function clearDetectionText() {
            document.getElementById('detectionText').value = '';
            document.getElementById('detectionResult').style.display = 'none';
        }

        function clearOptimizationText() {
            document.getElementById('optimizationText').value = '';
            document.getElementById('optimizationResult').style.display = 'none';
        }

        function loadSampleText() {
            const sampleText = `åœ¨ç°ä»£å•†ä¸šç¯å¢ƒä¸­ï¼Œæ•°æ®åˆ†ææ˜¾è‘—æå‡äº†ä¼ä¸šçš„å†³ç­–æ•ˆç‡ã€‚é€šè¿‡æœ‰æ•ˆçš„æ•°æ®æŒ–æ˜æŠ€æœ¯ï¼Œä¼ä¸šèƒ½å¤ŸæˆåŠŸè¯†åˆ«å¸‚åœºè¶‹åŠ¿ï¼Œä»è€Œå®ç°æ›´ç²¾å‡†çš„å¸‚åœºå®šä½ã€‚è¿™ç§æ–¹æ³•ä¸ä»…ä¼˜åŒ–äº†èµ„æºé…ç½®ï¼Œè¿˜ç¡®ä¿äº†ä¼ä¸šåœ¨ç«äº‰æ¿€çƒˆçš„å¸‚åœºä¸­ä¿æŒé¢†å…ˆåœ°ä½ã€‚é‡è¦çš„æ˜¯ï¼Œå®Œå–„çš„æ•°æ®åˆ†æä½“ç³»ä¸ºä¼ä¸šæä¾›äº†å…³é”®çš„ç«äº‰ä¼˜åŠ¿ã€‚`;
            document.getElementById('detectionText').value = sampleText;
        }

        function copyOptimizedText() {
            const optimizedText = document.getElementById('optimizedTextContent').textContent;
            if (!optimizedText) {
                alert('æš‚æ— å¯å¤åˆ¶çš„ä¼˜åŒ–æ–‡æœ¬');
                return;
            }
            
            navigator.clipboard.writeText(optimizedText).then(() => {
                alert('ä¼˜åŒ–åçš„æ–‡æœ¬å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // æ–‡æ¡£ä¸Šä¼ ç›¸å…³åŠŸèƒ½

        // æ–‡ä»¶æ‹–æ‹½å¤„ç†
        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶
        function handleFile(file) {
            // éªŒè¯æ–‡ä»¶ç±»å‹
            const allowedTypes = ['application/pdf', 'application/msword', 
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                                'text/plain'];
            
            if (!allowedTypes.includes(file.type)) {
                alert('è¯·ä¸Šä¼ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼šPDFã€DOCã€DOCXã€TXT');
                return;
            }

            // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                return;
            }

            uploadedFile = file;
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileInfo').style.display = 'block';

            // è¯»å–æ–‡ä»¶å†…å®¹
            readFileContent(file);
        }

        // è¯»å–æ–‡ä»¶å†…å®¹
        function readFileContent(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                if (file.type === 'text/plain') {
                    currentDocumentText = e.target.result;
                    const actualWords = currentDocumentText.length;
                    alert(`æ–‡æœ¬æ–‡ä»¶è§£æå®Œæˆï¼\næ–‡ä»¶ï¼š${file.name}\nå¤§å°ï¼š${formatFileSize(file.size)}\nå®é™…å­—æ•°ï¼š${actualWords.toLocaleString()} å­—`);
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    // å¤„ç†DOCXæ–‡ä»¶
                    extractDocxContent(e.target.result, file, 'plagiarism');
                } else if (file.type === 'application/pdf') {
                    // å¤„ç†PDFæ–‡ä»¶
                    extractPdfContent(e.target.result, file, 'plagiarism');
                } else {
                    // å…¶ä»–æ ¼å¼æš‚ä¸æ”¯æŒ
                    alert('æš‚ä¸æ”¯æŒè¯¥æ–‡ä»¶æ ¼å¼çš„å®Œæ•´è§£æï¼Œè¯·ä½¿ç”¨TXTæˆ–DOCXæ ¼å¼ã€‚');
                }
            };

            reader.onerror = function(error) {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };

            // å¯¹äºæ–‡æœ¬æ–‡ä»¶ä½¿ç”¨readAsTextï¼Œå¯¹äºäºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨readAsArrayBuffer
            if (file.type === 'text/plain') {
                reader.readAsText(file, 'UTF-8');
            } else {
            reader.readAsArrayBuffer(file);
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // åˆ‡æ¢åˆ°æ–‡æœ¬è¾“å…¥æ¨¡å¼
        function switchToTextInput() {
            const textArea = document.getElementById('plagiarismText');
            const uploadArea = document.querySelector('#plagiarism .upload-area');
            
            if (textArea.style.display === 'none') {
                textArea.style.display = 'block';
                uploadArea.style.display = 'none';
                textArea.value = currentDocumentText;
            } else {
                textArea.style.display = 'none';
                uploadArea.style.display = 'block';
            }
        }

        // å¼€å§‹æŸ¥é‡æ£€æµ‹
        function startPlagiarismCheck() {
            let textToCheck = '';
            
            if (document.getElementById('plagiarismText').style.display !== 'none') {
                textToCheck = document.getElementById('plagiarismText').value.trim();
            } else if (currentDocumentText) {
                textToCheck = currentDocumentText;
            }

            if (!textToCheck) {
                alert('è¯·ä¸Šä¼ æ–‡æ¡£æˆ–è¾“å…¥éœ€è¦æ£€æµ‹çš„æ–‡æœ¬å†…å®¹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('plagiarismLoading').style.display = 'block';
            document.getElementById('plagiarismReport').style.display = 'none';

                         // æ¨¡æ‹ŸæŸ¥é‡åˆ†æï¼ˆä¼˜åŒ–é€Ÿåº¦ï¼‰
            setTimeout(() => {
                const plagiarismResult = performPlagiarismAnalysis(textToCheck);
                displayPlagiarismReport(plagiarismResult);
                
                document.getElementById('plagiarismLoading').style.display = 'none';
                document.getElementById('plagiarismReport').style.display = 'block';
            }, 1500);
        }

        // æ‰§è¡ŒæŸ¥é‡åˆ†æï¼ˆåŸºäºAIGCæ ‡å‡†è§„åˆ™ï¼‰
        function performPlagiarismAnalysis(text) {
            const totalWords = text.length;
            
            // é¦–å…ˆè¿›è¡ŒAIGCç‰¹å¾åˆ†æ
            const aigcAnalysis = performAIGCAnalysis(text);
            
            // åŸºäºAIGCåˆ†æç»“æœè°ƒæ•´ç›¸ä¼¼åº¦æ£€æµ‹
            let baseSimilarity = Math.floor(Math.random() * 25) + 10; // åŸºç¡€10-35%
            
            // æ ¹æ®AIGCç‰¹å¾æé«˜ç›¸ä¼¼åº¦
            const aigcBonus = Math.floor(aigcAnalysis.aiProbability * 0.3); // AIGCæ¦‚ç‡é«˜çš„è¯å¢åŠ ç›¸ä¼¼åº¦
            const totalSimilarity = Math.min(85, baseSimilarity + aigcBonus);
            
            const internetSimilarity = Math.floor(totalSimilarity * 0.6);
            const paperSimilarity = Math.floor(totalSimilarity * 0.3);
            const selfCitation = Math.floor(totalSimilarity * 0.1);
            
            const duplicateWords = Math.floor(totalWords * (totalSimilarity / 100));
            
            // åˆ†ææ–‡æœ¬æ®µè½ï¼Œé‡ç‚¹å…³æ³¨AIGCç‰¹å¾
            const sentences = text.split(/[ã€‚ï¼ï¼Ÿ.!?]+/).filter(s => s.trim().length > 10);
            const analysisSegments = [];
            
            // åŸºäºAIGCæ£€æµ‹ç»“æœè¿›è¡Œæ™ºèƒ½ç›¸ä¼¼ç‰‡æ®µæ£€æµ‹
            for (let i = 0; i < Math.min(sentences.length, 6); i++) {
                const sentence = sentences[i].trim();
                if (sentence.length < 15) continue;
                
                // æ£€æŸ¥è¯¥å¥å­çš„AIGCç‰¹å¾
                const sentenceAIGCScore = analyzeSentenceAIGCFeatures(sentence);
                
                // AIGCç‰¹å¾è¶Šæ˜æ˜¾ï¼Œè¶Šå®¹æ˜“è¢«æ ‡è®°ä¸ºç›¸ä¼¼
                const flagProbability = 0.3 + (sentenceAIGCScore / 100) * 0.5;
                
                if (Math.random() < flagProbability) {
                    const similarityLevel = sentenceAIGCScore > 70 ? 2 : (sentenceAIGCScore > 40 ? 1 : 0);
                    const similarityPercentage = Math.min(95, 60 + sentenceAIGCScore * 0.3);
                    const sources = generateMockSources();
                    const flagReason = generateFlagReason(sentenceAIGCScore, sentence);
                    
                    analysisSegments.push({
                        originalText: sentence,
                        similarityLevel: similarityLevel,
                        similarityPercentage: Math.floor(similarityPercentage),
                        sources: sources,
                        flagReason: flagReason,
                        aigcScore: sentenceAIGCScore,
                        suggestion: generateReductionSuggestion(sentence, sentenceAIGCScore, flagReason)
                    });
                }
            }

            return {
                totalSimilarity,
                internetSimilarity,
                paperSimilarity,
                selfCitation,
                totalWords,
                duplicateWords,
                similarSegments: analysisSegments.length,
                sourcesCount: Math.floor(Math.random() * 50) + 20,
                analysisSegments,
                checkTime: new Date().toLocaleString('zh-CN'),
                aigcAnalysis: aigcAnalysis // æ·»åŠ AIGCåˆ†æç»“æœ
            };
        }

        // åˆ†æå•ä¸ªå¥å­çš„AIGCç‰¹å¾
        function analyzeSentenceAIGCFeatures(sentence) {
            let score = 0;
            
            // 1. æ£€æŸ¥AIå¸¸ç”¨è¯æ±‡
            const aiWords = ['æ˜¾è‘—', 'é‡è¦', 'æœ‰æ•ˆ', 'æˆåŠŸ', 'å®Œå–„', 'ä¼˜åŒ–', 'æå‡', 'å®ç°', 'ç¡®ä¿', 'è¿›ä¸€æ­¥', 'æ·±å…¥', 'å…¨é¢', 'ç»¼åˆ', 'ç³»ç»Ÿ', 'å…³é”®'];
            const aiWordCount = aiWords.filter(word => sentence.includes(word)).length;
            score += aiWordCount * 15;
            
            // 2. æ£€æŸ¥å¥å­é•¿åº¦ï¼ˆAIç”Ÿæˆçš„å¥å­å¾€å¾€é•¿åº¦é€‚ä¸­ä¸”ä¸€è‡´ï¼‰
            const length = sentence.length;
            if (length >= 20 && length <= 50) score += 20;
            if (length >= 40 && length <= 60) score += 10;
            
            // 3. æ£€æŸ¥å¤æ‚å¥å¼æ ‡å¿—
            const complexMarkers = ['é€šè¿‡', 'åŸºäº', 'åˆ©ç”¨', 'é‡‡ç”¨', 'è¿ç”¨', 'å€ŸåŠ©', 'ä¾æ‰˜'];
            if (complexMarkers.some(marker => sentence.includes(marker))) score += 15;
            
            // 4. æ£€æŸ¥è¢«åŠ¨è¯­æ€
            if (sentence.includes('è¢«') || sentence.includes('å¾—åˆ°') || sentence.includes('å—åˆ°')) score += 10;
            
            // 5. æ£€æŸ¥ç¼ºä¹ä¸ªäººåŒ–è¡¨è¾¾
            const personalWords = ['æˆ‘', 'æˆ‘ä»¬', 'ä¸ªäºº', 'æˆ‘è§‰å¾—', 'æˆ‘è®¤ä¸º', 'æ®æˆ‘', 'ä»æˆ‘'];
            if (!personalWords.some(word => sentence.includes(word))) score += 15;
            
            // 6. æ£€æŸ¥è¿‡äºæ­£å¼çš„è¡¨è¾¾
            const formalWords = ['é‰´äº', 'åŸºæ­¤', 'ç»¼ä¸Šæ‰€è¿°', 'ç”±æ­¤å¯è§', 'ä¸éš¾å‘ç°'];
            if (formalWords.some(word => sentence.includes(word))) score += 20;
            
            return Math.min(100, score);
        }
        
        // ç”Ÿæˆæ ‡è®°åŸå› 
        function generateFlagReason(aigcScore, sentence) {
            const reasons = [];
            
            if (aigcScore > 70) {
                reasons.push('é«˜åº¦ç–‘ä¼¼AIç”Ÿæˆå†…å®¹');
            } else if (aigcScore > 40) {
                reasons.push('å¯èƒ½åŒ…å«AIç”Ÿæˆç‰¹å¾');
            }
            
            // å…·ä½“ç‰¹å¾åˆ†æ
            const aiWords = ['æ˜¾è‘—', 'é‡è¦', 'æœ‰æ•ˆ', 'æˆåŠŸ', 'å®Œå–„', 'ä¼˜åŒ–', 'æå‡', 'å®ç°', 'ç¡®ä¿'];
            const foundAiWords = aiWords.filter(word => sentence.includes(word));
            if (foundAiWords.length > 0) {
                reasons.push(`åŒ…å«AIå¸¸ç”¨è¯æ±‡: ${foundAiWords.join('ã€')}`);
            }
            
            if (sentence.includes('é€šè¿‡') || sentence.includes('åŸºäº')) {
                reasons.push('ä½¿ç”¨äº†å…¸å‹AIå¥å¼ç»“æ„');
            }
            
            const personalWords = ['æˆ‘', 'æˆ‘ä»¬', 'ä¸ªäºº', 'æˆ‘è§‰å¾—'];
            if (!personalWords.some(word => sentence.includes(word))) {
                reasons.push('ç¼ºä¹ä¸ªäººåŒ–è¡¨è¾¾');
            }
            
            return reasons.length > 0 ? reasons.join('ï¼›') : 'ç»“æ„ç›¸ä¼¼åº¦è¾ƒé«˜';
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ¥æº
        function generateMockSources() {
            const sources = [
                { title: 'åŸºäºæ·±åº¦å­¦ä¹ çš„æ–‡æœ¬åˆ†æç ”ç©¶', author: 'å¼ ä¸‰ç­‰', year: '2023', url: 'https://example.com/paper1' },
                { title: 'äººå·¥æ™ºèƒ½åœ¨æ–‡æœ¬å¤„ç†ä¸­çš„åº”ç”¨', author: 'æå››ç­‰', year: '2022', url: 'https://example.com/paper2' },
                { title: 'æœºå™¨å­¦ä¹ ç®—æ³•ä¼˜åŒ–ç­–ç•¥åˆ†æ', author: 'ç‹äº”ç­‰', year: '2023', url: 'https://example.com/paper3' },
                { title: 'æ•°æ®æŒ–æ˜æŠ€æœ¯å‘å±•ç°çŠ¶ç ”ç©¶', author: 'èµµå…­ç­‰', year: '2021', url: 'https://example.com/paper4' }
            ];
            
            const count = Math.floor(Math.random() * 3) + 1;
            return sources.slice(0, count);
        }

        // ç”Ÿæˆé™é‡å»ºè®®ï¼ˆåŸºäºAIGCç‰¹å¾åˆ†æï¼‰
        function generateReductionSuggestion(text, aigcScore = 0, flagReason = '') {
            const suggestions = [];
            
            // åŸºäºAIGCå¾—åˆ†å’Œæ ‡è®°åŸå› ç”Ÿæˆé’ˆå¯¹æ€§å»ºè®®
            if (flagReason.includes('AIå¸¸ç”¨è¯æ±‡') || aigcScore > 50) {
                const aiSynonyms = {
                    'æ˜¾è‘—': ['æ˜æ˜¾', 'çªå‡º', 'æ¸…æ¥š'],
                    'é‡è¦': ['å…³é”®', 'æ ¸å¿ƒ', 'ä¸»è¦'],
                    'æœ‰æ•ˆ': ['ç®¡ç”¨', 'å¥½ç”¨', 'å®ç”¨'],
                    'å®ç°': ['è¾¾åˆ°', 'å®Œæˆ', 'åšåˆ°'],
                    'ç¡®ä¿': ['ä¿è¯', 'è®©', 'ä½¿å¾—'],
                    'ä¼˜åŒ–': ['æ”¹è¿›', 'æ”¹å–„', 'å®Œå–„'],
                    'æå‡': ['æ”¹å–„', 'å¢å¼º', 'åŠ å¼º'],
                    'å®Œå–„': ['æ”¹è¿›', 'å¥å…¨', 'å……å®'],
                    'æˆåŠŸ': ['é¡ºåˆ©', 'æœ‰æ•ˆ', 'åœ†æ»¡'],
                    'å…³é”®': ['æ ¸å¿ƒ', 'ä¸»è¦', 'é‡ç‚¹'],
                    'è¿›ä¸€æ­¥': ['æ›´åŠ ', 'è¿›è€Œ', 'æ¥ç€'],
                    'æ·±å…¥': ['è¯¦ç»†', 'ä»”ç»†', 'æ·±åˆ»'],
                    'å…¨é¢': ['å®Œæ•´', 'è¯¦å°½', 'å‘¨å…¨'],
                    'ç»¼åˆ': ['æ•´ä½“', 'æ€»ä½“', 'å…¨æ–¹ä½'],
                    'ç³»ç»Ÿ': ['å®Œæ•´', 'å…¨å¥—', 'æ•´ä½“']
                };
                
                let improvedText = text;
                Object.keys(aiSynonyms).forEach(word => {
                    if (text.includes(word)) {
                        const synonyms = aiSynonyms[word];
                        const replacement = synonyms[Math.floor(Math.random() * synonyms.length)];
                        improvedText = improvedText.replace(new RegExp(word, 'g'), replacement);
                    }
                });
                
                suggestions.push({
                    type: 'AIè¯æ±‡æ›¿æ¢',
                    description: 'æ›¿æ¢AIå¸¸ç”¨è¯æ±‡ï¼Œä½¿ç”¨æ›´è‡ªç„¶çš„è¡¨è¾¾',
                    improvedText: improvedText,
                    priority: 'high'
                });
            }
            
            if (flagReason.includes('AIå¥å¼ç»“æ„') || text.includes('é€šè¿‡') || text.includes('åŸºäº')) {
                let restructuredText = text;
                
                // è°ƒæ•´"é€šè¿‡...å®ç°"å¥å¼
                restructuredText = restructuredText.replace(/é€šè¿‡(.+?)å®ç°(.+)/g, (match, method, result) => {
                    return `${method.trim()}è®©æˆ‘ä»¬${result.trim()}`;
                });
                
                // è°ƒæ•´"åŸºäº...çš„"å¥å¼
                restructuredText = restructuredText.replace(/åŸºäº(.+?)çš„(.+)/g, (match, basis, content) => {
                    return `æ ¹æ®${basis.trim()}ï¼Œ${content.trim()}`;
                });
                
                suggestions.push({
                    type: 'å¥å¼é‡æ„',
                    description: 'è°ƒæ•´AIå¸¸è§å¥å¼ï¼Œä½¿è¡¨è¾¾æ›´åŠ è‡ªç„¶',
                    improvedText: restructuredText,
                    priority: 'high'
                });
            }
            
            if (flagReason.includes('ç¼ºä¹ä¸ªäººåŒ–è¡¨è¾¾') || aigcScore > 40) {
                const personalPrefixes = ['æˆ‘è§‰å¾—', 'ä»æˆ‘çš„ç»éªŒæ¥çœ‹', 'ä¸ªäººè®¤ä¸º', 'æ®æˆ‘è§‚å¯Ÿ', 'åœ¨æˆ‘çœ‹æ¥', 'æˆ‘å‘ç°'];
                const randomPrefix = personalPrefixes[Math.floor(Math.random() * personalPrefixes.length)];
                const personalizedText = randomPrefix + 'ï¼Œ' + text.toLowerCase();
                
                suggestions.push({
                    type: 'ä¸ªäººåŒ–è¡¨è¾¾',
                    description: 'å¢åŠ ä¸ªäººè§‚ç‚¹å’Œä¸»è§‚è‰²å½©ï¼Œæå‡äººæ–‡æ°”æ¯',
                    improvedText: personalizedText,
                    priority: 'medium'
                });
            }
            
            // è¢«åŠ¨è¯­æ€è½¬æ¢
            if (text.includes('è¢«') || text.includes('å¾—åˆ°') || text.includes('å—åˆ°')) {
                let activeText = text;
                activeText = activeText.replace(/è¢«(\w+)/g, (match, verb) => {
                    return `ç»è¿‡${verb}å`;
                });
                activeText = activeText.replace(/å¾—åˆ°(\w+)/g, (match, object) => {
                    return `è·å¾—äº†${object}`;
                });
                
                suggestions.push({
                    type: 'ä¸»è¢«åŠ¨è½¬æ¢',
                    description: 'å°†è¢«åŠ¨è¯­æ€è½¬ä¸ºä¸»åŠ¨è¯­æ€ï¼Œå¢åŠ è¯­è¨€æ´»åŠ›',
                    improvedText: activeText,
                    priority: 'medium'
                });
            }
            
            // å¥å­æ‹†åˆ†ï¼ˆé’ˆå¯¹è¿‡é•¿å¥å­ï¼‰
            if (text.length > 50 && (text.includes('ï¼Œ') || text.includes('ï¼›'))) {
                const parts = text.split(/[ï¼Œï¼›]/);
                if (parts.length >= 2) {
                    const splitText = parts[0].trim() + 'ã€‚å¦å¤–ï¼Œ' + parts.slice(1).join('ï¼Œ').trim();
                    suggestions.push({
                        type: 'å¥å­æ‹†åˆ†',
                        description: 'å°†é•¿å¥æ‹†åˆ†ä¸ºçŸ­å¥ï¼Œæé«˜å¯è¯»æ€§',
                        improvedText: splitText,
                        priority: 'low'
                    });
                }
            }
            
            // å¦‚æœæ²¡æœ‰ç‰¹æ®Šå»ºè®®ï¼Œæä¾›é€šç”¨å»ºè®®
            if (suggestions.length === 0) {
                suggestions.push({
                    type: 'è¯­è¨€æ¶¦è‰²',
                    description: 'å¢åŠ è¯­è¨€çš„è‡ªç„¶åº¦å’Œä¸ªäººè‰²å½©',
                    improvedText: 'æˆ‘è®¤ä¸ºï¼Œ' + text.replace(/ã€‚$/, '') + 'æ˜¯æ¯”è¾ƒåˆç†çš„ã€‚',
                    priority: 'low'
                });
            }
            
            // æŒ‰ä¼˜å…ˆçº§æ’åºå¹¶è¿”å›æœ€ä½³å»ºè®®
            suggestions.sort((a, b) => {
                const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
            
            return suggestions[0]; // è¿”å›ä¼˜å…ˆçº§æœ€é«˜çš„å»ºè®®
        }

        // æ˜¾ç¤ºæŸ¥é‡æŠ¥å‘Š
        function displayPlagiarismReport(result) {
            // æ›´æ–°ç›¸ä¼¼åº¦æ•°æ®
            document.getElementById('totalSimilarity').textContent = result.totalSimilarity + '%';
            document.getElementById('internetSimilarity').textContent = result.internetSimilarity + '%';
            document.getElementById('paperSimilarity').textContent = result.paperSimilarity + '%';
            document.getElementById('selfCitation').textContent = result.selfCitation + '%';

            // æ›´æ–°æ‘˜è¦ä¿¡æ¯
            document.getElementById('checkTime').textContent = result.checkTime;
            document.getElementById('totalWords').textContent = result.totalWords + ' å­—';
            document.getElementById('duplicateWords').textContent = result.duplicateWords + ' å­—';
            document.getElementById('similarSegments').textContent = result.similarSegments + ' ä¸ª';
            document.getElementById('sourcesCount').textContent = result.sourcesCount + ' ä¸ª';

            // ç”Ÿæˆè¯¦ç»†åˆ†æ
            const analysisContainer = document.getElementById('detailedAnalysis');
            analysisContainer.innerHTML = '';

            result.analysisSegments.forEach((segment, index) => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'text-segment';
                
                const highlightClass = segment.similarityLevel === 2 ? 'highlight-red' : 
                                     segment.similarityLevel === 1 ? 'highlight-yellow' : 'highlight-green';

                segmentDiv.innerHTML = `
                    <div class="original-text">
                        <strong>åŸæ–‡ç‰‡æ®µ ${index + 1}ï¼š</strong><br>
                        <span class="${highlightClass}">${segment.originalText}</span>
                    </div>
                    <div class="source-info">
                        <strong>ç›¸ä¼¼åº¦ï¼š${segment.similarityPercentage}%</strong>
                        ${segment.aigcScore ? `<span style="margin-left: 15px; color: #dc3545;">AIGCé£é™©ï¼š${segment.aigcScore}åˆ†</span>` : ''}<br>
                        <strong>æ ‡è®°åŸå› ï¼š</strong><span style="color: #dc3545;">${segment.flagReason || 'ç»“æ„ç›¸ä¼¼åº¦è¾ƒé«˜'}</span><br>
                        <strong>æ¥æºï¼š</strong>
                        ${segment.sources.map(source => 
                            `<a href="${source.url}" class="source-link" target="_blank">
                                ${source.title} (${source.author}, ${source.year})
                            </a>`
                        ).join('<br>')}
                    </div>
                `;
                analysisContainer.appendChild(segmentDiv);
            });

            // ç”Ÿæˆé™é‡å»ºè®®
            const suggestionsContainer = document.getElementById('reductionSuggestions');
            suggestionsContainer.innerHTML = '';

            result.analysisSegments.forEach((segment, index) => {
                const suggestionCard = document.createElement('div');
                suggestionCard.className = 'suggestion-card';
                
                suggestionCard.innerHTML = `
                    <div class="suggestion-header">
                        <span class="suggestion-icon">ğŸ’¡</span>
                        <strong>ç‰‡æ®µ ${index + 1} - ${segment.suggestion.type}</strong>
                    </div>
                    <p>${segment.suggestion.description}</p>
                    <div class="original-snippet">
                        <strong>åŸæ–‡ï¼š</strong>${segment.originalText}
                    </div>
                    <div class="improved-snippet">
                        <strong>å»ºè®®æ”¹ä¸ºï¼š</strong>${segment.suggestion.improvedText}
                    </div>
                `;
                suggestionsContainer.appendChild(suggestionCard);
            });

            if (result.analysisSegments.length === 0) {
                suggestionsContainer.innerHTML = `
                    <div class="suggestion-card">
                        <div class="suggestion-text">æ­å–œï¼æœªå‘ç°æ˜æ˜¾çš„é‡å¤å†…å®¹ï¼Œæ–‡æ¡£åŸåˆ›æ€§è‰¯å¥½ã€‚</div>
                    </div>
                `;
            }
        }

        // æ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ è¿›åº¦
        function simulateUploadProgress(modulePrefix, file, callback) {
            const progressElement = document.getElementById(modulePrefix + 'ProgressFill');
            const textElement = document.getElementById(modulePrefix + 'ProgressText');
            const progressContainer = document.getElementById(modulePrefix + 'UploadProgress');
            
            progressContainer.style.display = 'block';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15 + 5; // æ¯æ¬¡å¢åŠ 5-20%
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        callback(file);
                    }, 500);
                }
                
                progressElement.style.width = progress + '%';
                textElement.textContent = `ä¸Šä¼ ä¸­... ${Math.floor(progress)}%`;
            }, 200);
        }

        // AIGCæ£€æµ‹æ¨¡å¼åˆ‡æ¢
        function switchDetectionMode(mode) {
            const textBtn = document.getElementById('detectionTextMode');
            const fileBtn = document.getElementById('detectionFileMode');
            const textArea = document.getElementById('detectionText');
            const uploadArea = document.getElementById('detectionUploadArea');
            
            if (mode === 'text') {
                textBtn.classList.add('active');
                fileBtn.classList.remove('active');
                textArea.style.display = 'block';
                uploadArea.style.display = 'none';
                document.getElementById('detectionFilePreview').style.display = 'none';
            } else {
                fileBtn.classList.add('active');
                textBtn.classList.remove('active');
                textArea.style.display = 'none';
                uploadArea.style.display = 'block';
            }
        }

        // AIGCæ£€æµ‹æ–‡ä»¶å¤„ç†
        function handleDetectionFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                simulateUploadProgress('detection', files[0], handleDetectionFile);
            }
        }

        function handleDetectionFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                simulateUploadProgress('detection', file, handleDetectionFile);
            }
        }

        function handleDetectionFile(file) {
            if (!validateFile(file)) return;
            
            detectionUploadedFile = file;
            document.getElementById('detectionFileName').textContent = file.name;
            document.getElementById('detectionFileSize').textContent = formatFileSize(file.size);
            document.getElementById('detectionFileInfo').style.display = 'block';
            
            readDetectionFileContent(file);
        }

        function readDetectionFileContent(file) {
            console.log('å¼€å§‹è¯»å–æ–‡ä»¶:', file.name, 'ç±»å‹:', file.type);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                console.log('æ–‡ä»¶è¯»å–å®Œæˆ');
                
                if (file.type === 'text/plain') {
                    console.log('å¤„ç†TXTæ–‡ä»¶');
                    detectionDocumentText = e.target.result;
                    const actualWords = detectionDocumentText.length;
                    document.getElementById('detectionPreviewContent').textContent = 
                        `æ–‡æœ¬æ–‡ä»¶è§£æå®Œæˆ (${file.name})\næ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}\nå®é™…å­—æ•°: ${actualWords.toLocaleString()} å­—\n\nå†…å®¹é¢„è§ˆ:\n` +
                        detectionDocumentText.substring(0, 300) + (detectionDocumentText.length > 300 ? '...' : '');
                    document.getElementById('detectionFilePreview').style.display = 'block';
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    // å¤„ç†DOCXæ–‡ä»¶
                    console.log('å¤„ç†DOCXæ–‡ä»¶');
                    extractDocxContent(e.target.result, file, 'detection');
                } else if (file.type === 'application/pdf') {
                    // å¤„ç†PDFæ–‡ä»¶
                    console.log('å¤„ç†PDFæ–‡ä»¶');
                    extractPdfContent(e.target.result, file, 'detection');
                } else {
                    // å…¶ä»–æ ¼å¼æš‚ä¸æ”¯æŒ
                    console.log('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼:', file.type);
                    alert('æš‚ä¸æ”¯æŒè¯¥æ–‡ä»¶æ ¼å¼çš„å®Œæ•´è§£æï¼Œè¯·ä½¿ç”¨TXTæˆ–DOCXæ ¼å¼ã€‚');
                }
            };
            
            reader.onerror = function(error) {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            
            // å¯¹äºæ–‡æœ¬æ–‡ä»¶ä½¿ç”¨readAsTextï¼Œå¯¹äºäºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨readAsArrayBuffer
            if (file.type === 'text/plain') {
                reader.readAsText(file, 'UTF-8');
            } else {
            reader.readAsArrayBuffer(file);
            }
        }

        // æ™ºèƒ½é™é‡æ¨¡å¼åˆ‡æ¢
        function switchOptimizationMode(mode) {
            const textBtn = document.getElementById('optimizationTextMode');
            const fileBtn = document.getElementById('optimizationFileMode');
            const textArea = document.getElementById('optimizationText');
            const uploadArea = document.getElementById('optimizationUploadArea');
            
            if (mode === 'text') {
                textBtn.classList.add('active');
                fileBtn.classList.remove('active');
                textArea.style.display = 'block';
                uploadArea.style.display = 'none';
                document.getElementById('optimizationFilePreview').style.display = 'none';
            } else {
                fileBtn.classList.add('active');
                textBtn.classList.remove('active');
                textArea.style.display = 'none';
                uploadArea.style.display = 'block';
            }
        }

        // æ™ºèƒ½é™é‡æ–‡ä»¶å¤„ç†
        function handleOptimizationFileDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                simulateUploadProgress('optimization', files[0], handleOptimizationFile);
            }
        }

        function handleOptimizationFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                simulateUploadProgress('optimization', file, handleOptimizationFile);
            }
        }

        function handleOptimizationFile(file) {
            if (!validateFile(file)) return;
            
            optimizationUploadedFile = file;
            document.getElementById('optimizationFileName').textContent = file.name;
            document.getElementById('optimizationFileSize').textContent = formatFileSize(file.size);
            document.getElementById('optimizationFileInfo').style.display = 'block';
            
            readOptimizationFileContent(file);
        }

        function readOptimizationFileContent(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                if (file.type === 'text/plain') {
                    optimizationDocumentText = e.target.result;
                    const actualWords = optimizationDocumentText.length;
                    document.getElementById('optimizationPreviewContent').textContent = 
                        `æ–‡æœ¬æ–‡ä»¶è§£æå®Œæˆ (${file.name})\næ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}\nå®é™…å­—æ•°: ${actualWords.toLocaleString()} å­—\n\nå†…å®¹é¢„è§ˆ:\n` +
                        optimizationDocumentText.substring(0, 300) + (optimizationDocumentText.length > 300 ? '...' : '');
                    document.getElementById('optimizationFilePreview').style.display = 'block';
                } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                    // å¤„ç†DOCXæ–‡ä»¶
                    extractDocxContent(e.target.result, file, 'optimization');
                } else if (file.type === 'application/pdf') {
                    // å¤„ç†PDFæ–‡ä»¶
                    extractPdfContent(e.target.result, file, 'optimization');
                } else {
                    // å…¶ä»–æ ¼å¼æš‚ä¸æ”¯æŒ
                    alert('æš‚ä¸æ”¯æŒè¯¥æ–‡ä»¶æ ¼å¼çš„å®Œæ•´è§£æï¼Œè¯·ä½¿ç”¨TXTæˆ–DOCXæ ¼å¼ã€‚');
                }
            };
            
            reader.onerror = function(error) {
                console.error('æ–‡ä»¶è¯»å–å¤±è´¥:', error);
                alert('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            
            // å¯¹äºæ–‡æœ¬æ–‡ä»¶ä½¿ç”¨readAsTextï¼Œå¯¹äºäºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨readAsArrayBuffer
            if (file.type === 'text/plain') {
                reader.readAsText(file, 'UTF-8');
            } else {
            reader.readAsArrayBuffer(file);
            }
        }

        // æ–‡ä»¶éªŒè¯å‡½æ•°
        function validateFile(file) {
            const allowedTypes = ['application/pdf', 'application/msword', 
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 
                                'text/plain'];
            
            if (!allowedTypes.includes(file.type)) {
                alert('è¯·ä¸Šä¼ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼šPDFã€DOCã€DOCXã€TXT');
                return false;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 10MB');
                return false;
            }
            
            return true;
        }

        // ä¿®æ”¹åŸæœ‰çš„analyzeTextå‡½æ•°
        function analyzeText() {
            let textToAnalyze = '';
            
            // æ£€æŸ¥å½“å‰æ¨¡å¼
            if (document.getElementById('detectionText').style.display !== 'none') {
                textToAnalyze = document.getElementById('detectionText').value.trim();
            } else if (detectionDocumentText) {
                textToAnalyze = detectionDocumentText;
            }

            if (!textToAnalyze) {
                alert('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹æˆ–ä¸Šä¼ æ–‡æ¡£è¿›è¡Œæ£€æµ‹');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('detectionLoading').style.display = 'block';
            document.getElementById('detectionResult').style.display = 'none';

            // æ¨¡æ‹Ÿåˆ†æå»¶æ—¶ï¼ˆä¼˜åŒ–é€Ÿåº¦ï¼‰
            setTimeout(() => {
                const analysis = performAIGCAnalysis(textToAnalyze);
                displayAnalysisResult(analysis);
                
                document.getElementById('detectionLoading').style.display = 'none';
                document.getElementById('detectionResult').style.display = 'block';
            }, 1200);
        }

        // è°ƒç”¨Ollama APIè¿›è¡ŒAIä¼˜åŒ–
        async function callOllamaAPI(text, prompt) {
            try {
                const response = await fetch('http://localhost:11434/api/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'deepseek-r1:8b',
                        prompt: prompt,
                        stream: false,
                        options: {
                            temperature: 0.7,
                            top_p: 0.9,
                            max_tokens: 2048
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.response;
            } catch (error) {
                console.error('Ollama APIè°ƒç”¨å¤±è´¥:', error);
                throw error;
            }
        }

        // ç”ŸæˆAIä¼˜åŒ–æç¤ºè¯
        function generateAIOptimizationPrompt(text, aigcAnalysis = null) {
            let prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æœ¬ä¼˜åŒ–ä¸“å®¶ï¼Œæ“…é•¿å°†AIç”Ÿæˆçš„æ–‡æœ¬æ”¹å†™å¾—æ›´åŠ è‡ªç„¶å’Œäººæ€§åŒ–ã€‚

**ä»»åŠ¡ç›®æ ‡ï¼š**
å¯¹ä»¥ä¸‹æ–‡æœ¬è¿›è¡Œé™é‡å’Œå»AIåŒ–å¤„ç†ï¼Œè®©å®ƒè¯»èµ·æ¥æ›´åƒçœŸäººå†™çš„ã€‚

**ä¼˜åŒ–è¦æ±‚ï¼š**
1. æ›¿æ¢AIå¸¸ç”¨è¯æ±‡ï¼ˆå¦‚"æ˜¾è‘—"ã€"é‡è¦"ã€"æœ‰æ•ˆ"ã€"å®ç°"ã€"ç¡®ä¿"ã€"ä¼˜åŒ–"ç­‰ï¼‰ä¸ºæ›´è‡ªç„¶çš„è¡¨è¾¾
2. è°ƒæ•´è¿‡äºæ­£å¼æˆ–æœºæ¢°åŒ–çš„å¥å¼ï¼Œç‰¹åˆ«æ˜¯"é€šè¿‡...å®ç°"ã€"åŸºäº...çš„"ç­‰å…¸å‹AIå¥å¼
3. å¢åŠ ä¸ªäººåŒ–è¡¨è¾¾å’Œä¸»è§‚è‰²å½©ï¼Œå¦‚"æˆ‘è§‰å¾—"ã€"ä»æˆ‘çš„ç»éªŒæ¥çœ‹"ã€"ä¸ªäººè®¤ä¸º"ç­‰
4. å°†è¢«åŠ¨è¯­æ€é€‚å½“è½¬æ¢ä¸ºä¸»åŠ¨è¯­æ€
5. æ‹†åˆ†è¿‡é•¿çš„å¥å­ï¼Œå¢åŠ å¥å¼å˜åŒ–
6. ä¿æŒåŸæ–‡çš„æ ¸å¿ƒæ„æ€å’Œä¸“ä¸šæ€§
7. ä½¿è¯­è¨€æ›´åŠ å£è¯­åŒ–å’Œç”ŸåŠ¨

**ä¼˜åŒ–åŸåˆ™ï¼š**
- ä¿æŒåŸæ–‡çš„æ ¸å¿ƒä¿¡æ¯å’Œé€»è¾‘ç»“æ„
- é¿å…è¿‡åº¦ä¼˜åŒ–å½±å“ä¸“ä¸šæ€§
- ç¡®ä¿è¯­è¨€è‡ªç„¶æµç•…
- å¢åŠ é€‚åº¦çš„ä¸ªäººè§‚ç‚¹å’Œæƒ…æ„Ÿè‰²å½©

**å¾…ä¼˜åŒ–æ–‡æœ¬ï¼š**
${text}

**è¯·ç›´æ¥è¾“å‡ºä¼˜åŒ–åçš„æ–‡æœ¬ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæˆ–è¯´æ˜ï¼š**`;

            // å¦‚æœæœ‰AIGCåˆ†æç»“æœï¼Œæ·»åŠ å…·ä½“çš„é—®é¢˜æŒ‡å¯¼
            if (aigcAnalysis && aigcAnalysis.detectedIssues) {
                const issues = aigcAnalysis.detectedIssues;
                let specificGuidance = '\n**æ£€æµ‹åˆ°çš„å…·ä½“é—®é¢˜ï¼š**\n';
                
                issues.forEach((issue, index) => {
                    if (issue.type === 'aiWords') {
                        specificGuidance += `${index + 1}. AIè¯æ±‡é—®é¢˜ï¼šæ–‡ä¸­åŒ…å«"${issue.text}"ï¼Œè¯·æ›¿æ¢ä¸ºæ›´è‡ªç„¶çš„è¡¨è¾¾\n`;
                    } else if (issue.type === 'structure') {
                        specificGuidance += `${index + 1}. å¥å¼ç»“æ„é—®é¢˜ï¼šå¥å­é•¿åº¦è¿‡äºä¸€è‡´ï¼Œéœ€è¦å¢åŠ å˜åŒ–\n`;
                    } else if (issue.type === 'emotion') {
                        specificGuidance += `${index + 1}. æƒ…æ„Ÿè¡¨è¾¾é—®é¢˜ï¼šç¼ºä¹ä¸ªäººåŒ–è‰²å½©ï¼Œéœ€è¦æ·»åŠ ä¸»è§‚è¡¨è¾¾\n`;
                    }
                });
                
                // å°†å…·ä½“æŒ‡å¯¼æ’å…¥åˆ°promptä¸­
                prompt = prompt.replace('**å¾…ä¼˜åŒ–æ–‡æœ¬ï¼š**', specificGuidance + '\n**å¾…ä¼˜åŒ–æ–‡æœ¬ï¼š**');
            }

            return prompt;
        }

        // AIä¼˜åŒ–æ–‡æœ¬
        async function performAIOptimization(text) {
            try {
                // å…ˆè¿›è¡ŒAIGCåˆ†æ
                const aigcAnalysis = performAIGCAnalysis(text);
                
                // ç”Ÿæˆä¼˜åŒ–æç¤ºè¯
                const prompt = generateAIOptimizationPrompt(text, aigcAnalysis);
                
                // è°ƒç”¨Ollama API
                const optimizedText = await callOllamaAPI(text, prompt);
                
                // éªŒè¯ä¼˜åŒ–æ•ˆæœ
                const finalAigcAnalysis = performAIGCAnalysis(optimizedText);
                const improvementPercent = Math.max(0, aigcAnalysis.aiProbability - finalAigcAnalysis.aiProbability);
                
                return {
                    originalText: text,
                    optimizedText: optimizedText.trim(),
                    suggestions: [
                        {
                            title: 'AIé©±åŠ¨ä¼˜åŒ–',
                            text: `ä½¿ç”¨DeepSeek R1-8Bæ¨¡å‹è¿›è¡Œæ™ºèƒ½é™é‡ï¼ŒåŸºäº${aigcAnalysis.detectedIssues.length}ä¸ªæ£€æµ‹é—®é¢˜è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–`
                        },
                        {
                            title: 'ä¼˜åŒ–æ•ˆæœè¯„ä¼°',
                            text: `AIç”Ÿæˆæ¦‚ç‡ä»${aigcAnalysis.aiProbability}%é™ä½åˆ°${finalAigcAnalysis.aiProbability}%ï¼Œæ”¹å–„äº†${improvementPercent.toFixed(1)}ä¸ªç™¾åˆ†ç‚¹`
                        }
                    ],
                    modifications: [{
                        type: 'ai_optimization',
                        original: text.substring(0, 100) + '...',
                        modified: optimizedText.substring(0, 100) + '...',
                        reason: 'AIæ¨¡å‹æ™ºèƒ½æ”¹å†™ï¼Œç»¼åˆä¼˜åŒ–å¤šä¸ªç»´åº¦'
                    }],
                    originalAigcScore: aigcAnalysis.aiProbability,
                    finalAigcScore: finalAigcAnalysis.aiProbability,
                    improvement: improvementPercent,
                    mode: 'ai'
                };
            } catch (error) {
                console.error('AIä¼˜åŒ–å¤±è´¥:', error);
                throw new Error('AIä¼˜åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥OllamaæœåŠ¡æˆ–å°è¯•è§„åˆ™ä¼˜åŒ–æ¨¡å¼');
            }
        }

        // æ··åˆä¼˜åŒ–ï¼ˆè§„åˆ™+AIï¼‰
        async function performHybridOptimization(text) {
            try {
                // å…ˆè¿›è¡Œè§„åˆ™ä¼˜åŒ–
                const ruleResult = performTextOptimization(text);
                
                // å†å¯¹è§„åˆ™ä¼˜åŒ–çš„ç»“æœè¿›è¡ŒAIä¼˜åŒ–
                const aiResult = await performAIOptimization(ruleResult.optimizedText);
                
                // åˆå¹¶ç»“æœ
                const combinedSuggestions = [
                    {
                        title: 'æ··åˆä¼˜åŒ–ç­–ç•¥',
                        text: 'å…ˆè¿›è¡Œè§„åˆ™åˆ†æå’Œåˆæ­¥ä¼˜åŒ–ï¼Œå†ä½¿ç”¨AIæ¨¡å‹è¿›è¡Œæ·±åº¦æ”¹å†™ï¼Œç»“åˆä¸¤ç§æ–¹æ³•çš„ä¼˜åŠ¿'
                    },
                    ...ruleResult.suggestions.slice(0, 2), // é€‰æ‹©å‰2ä¸ªè§„åˆ™ä¼˜åŒ–å»ºè®®
                    ...aiResult.suggestions
                ];

                return {
                    originalText: text,
                    optimizedText: aiResult.optimizedText,
                    suggestions: combinedSuggestions,
                    modifications: [...ruleResult.modifications, ...aiResult.modifications],
                    originalAigcScore: ruleResult.originalAigcScore,
                    finalAigcScore: aiResult.finalAigcScore,
                    improvement: ruleResult.originalAigcScore - aiResult.finalAigcScore,
                    mode: 'hybrid'
                };
            } catch (error) {
                console.error('æ··åˆä¼˜åŒ–å¤±è´¥:', error);
                // å¦‚æœAIä¼˜åŒ–å¤±è´¥ï¼Œå›é€€åˆ°çº¯è§„åˆ™ä¼˜åŒ–
                const ruleResult = performTextOptimization(text);
                ruleResult.suggestions.unshift({
                    title: 'ä¼˜åŒ–æ¨¡å¼é™çº§',
                    text: 'AIä¼˜åŒ–æœåŠ¡ä¸å¯ç”¨ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢åˆ°è§„åˆ™ä¼˜åŒ–æ¨¡å¼'
                });
                return ruleResult;
            }
        }

        // ä¿®æ”¹åŸæœ‰çš„optimizeTextå‡½æ•°
        async function optimizeText() {
            let textToOptimize = '';
            
            // æ£€æŸ¥å½“å‰æ¨¡å¼
            if (document.getElementById('optimizationText').style.display !== 'none') {
                textToOptimize = document.getElementById('optimizationText').value.trim();
            } else if (optimizationDocumentText) {
                textToOptimize = optimizationDocumentText;
            }

            if (!textToOptimize) {
                alert('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹æˆ–ä¸Šä¼ æ–‡æ¡£è¿›è¡Œé™é‡');
                return;
            }

            // è·å–é€‰æ‹©çš„ä¼˜åŒ–æ¨¡å¼
            const selectedMode = document.querySelector('input[name="optimizationMode"]:checked').value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('optimizationLoading').style.display = 'block';
            document.getElementById('optimizationResult').style.display = 'none';

            try {
                let optimizedData;
                
                switch (selectedMode) {
                    case 'ai':
                        optimizedData = await performAIOptimization(textToOptimize);
                        break;
                    case 'hybrid':
                        optimizedData = await performHybridOptimization(textToOptimize);
                        break;
                    default: // 'rule'
                        optimizedData = performTextOptimization(textToOptimize);
                        break;
                }
                
                displayOptimizationResult(optimizedData);
                
                document.getElementById('optimizationLoading').style.display = 'none';
                document.getElementById('optimizationResult').style.display = 'block';
                
            } catch (error) {
                console.error('ä¼˜åŒ–è¿‡ç¨‹å‡ºé”™:', error);
                document.getElementById('optimizationLoading').style.display = 'none';
                alert('ä¼˜åŒ–å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¿®æ”¹æ¸…ç©ºå‡½æ•°
        function clearDetectionText() {
            detectionUploadedFile = null;
            detectionDocumentText = '';
            document.getElementById('detectionText').value = '';
            document.getElementById('detectionResult').style.display = 'none';
            document.getElementById('detectionFileInfo').style.display = 'none';
            document.getElementById('detectionFilePreview').style.display = 'none';
            document.getElementById('detectionFileInput').value = '';
        }

        function clearOptimizationText() {
            optimizationUploadedFile = null;
            optimizationDocumentText = '';
            document.getElementById('optimizationText').value = '';
            document.getElementById('optimizationResult').style.display = 'none';
            document.getElementById('optimizationFileInfo').style.display = 'none';
            document.getElementById('optimizationFilePreview').style.display = 'none';
            document.getElementById('optimizationFileInput').value = '';
        }

        // æ¸…ç©ºæŸ¥é‡æ•°æ®
        function clearPlagiarismData() {
            uploadedFile = null;
            currentDocumentText = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('plagiarismText').value = '';
            document.getElementById('plagiarismText').style.display = 'none';
            document.querySelector('#plagiarism .upload-area').style.display = 'block';
            document.getElementById('plagiarismReport').style.display = 'none';
            document.getElementById('fileInput').value = '';
        }

        // PDFæ–‡ä»¶å†…å®¹æå–å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        function extractPdfContent(arrayBuffer, file, module) {
            // ç”±äºPDFè§£ææ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªåŸºç¡€çš„æç¤º
            const text = `PDFæ–‡ä»¶è§£æåŠŸèƒ½éœ€è¦æ›´å¤æ‚çš„åº“æ”¯æŒã€‚\næ–‡ä»¶åï¼š${file.name}\næ–‡ä»¶å¤§å°ï¼š${formatFileSize(file.size)}\n\nè¯·å°†PDFè½¬æ¢ä¸ºWordæ–‡æ¡£æˆ–å¤åˆ¶æ–‡æœ¬å†…å®¹è¿›è¡Œæ£€æµ‹ã€‚`;
            
            if (module === 'detection') {
                detectionDocumentText = text;
                document.getElementById('detectionPreviewContent').textContent = text;
                document.getElementById('detectionFilePreview').style.display = 'block';
            } else if (module === 'optimization') {
                optimizationDocumentText = text;
                document.getElementById('optimizationPreviewContent').textContent = text;
                document.getElementById('optimizationFilePreview').style.display = 'block';
            } else if (module === 'plagiarism') {
                currentDocumentText = text;
                alert('PDFæ–‡ä»¶æ£€æµ‹åŠŸèƒ½æš‚æ—¶ä¸å®Œæ•´ï¼Œå»ºè®®è½¬æ¢ä¸ºWordæ–‡æ¡£åé‡æ–°ä¸Šä¼ ã€‚');
            }
        }

        // çœŸå®çš„DOCXå†…å®¹æå–å‡½æ•°
        function extractDocxContent(arrayBuffer, file, module) {
            console.log('å°è¯•è§£æDOCXæ–‡ä»¶:', file.name);
            console.log('Mammothåº“åŠ è½½çŠ¶æ€:', typeof mammoth !== 'undefined');
            
            if (typeof mammoth === 'undefined') {
                console.error('Mammoth library not loaded');
                alert('DOCXè§£æåº“æœªæ­£ç¡®åŠ è½½ï¼Œå°†ä½¿ç”¨å¤‡ç”¨è§£ææ–¹æ³•');
                fallbackExtraction(arrayBuffer, file, module);
                return;
            }

            mammoth.extractRawText({arrayBuffer: arrayBuffer})
                .then(function(result) {
                    console.log('Mammothè§£ææˆåŠŸ');
                    const documentContent = result.value;
                    const actualWords = documentContent.length;
                    const messages = result.messages;
                    
                    console.log('è§£æå‡ºçš„å†…å®¹é•¿åº¦:', actualWords);
                    if (messages.length > 0) {
                        console.log('è§£æè­¦å‘Š:', messages);
                    }
            
            // æ ¹æ®æ¨¡å—è®¾ç½®ç›¸åº”çš„å˜é‡
                         if (module === 'detection') {
                detectionDocumentText = documentContent;
                document.getElementById('detectionPreviewContent').textContent = 
                            `DOCXæ–‡æ¡£è§£æå®Œæˆ (${file.name})\næ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}\nå®é™…å­—æ•°: ${actualWords.toLocaleString()} å­—\n\nå†…å®¹é¢„è§ˆ:\n` + 
                            documentContent.substring(0, 300) + (documentContent.length > 300 ? '...' : '');
                document.getElementById('detectionFilePreview').style.display = 'block';
            } else if (module === 'optimization') {
                optimizationDocumentText = documentContent;
                document.getElementById('optimizationPreviewContent').textContent = 
                            `DOCXæ–‡æ¡£è§£æå®Œæˆ (${file.name})\næ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}\nå®é™…å­—æ•°: ${actualWords.toLocaleString()} å­—\n\nå†…å®¹é¢„è§ˆ:\n` + 
                            documentContent.substring(0, 300) + (documentContent.length > 300 ? '...' : '');
                document.getElementById('optimizationFilePreview').style.display = 'block';
            } else if (module === 'plagiarism') {
                currentDocumentText = documentContent;
                        alert(`DOCXæ–‡æ¡£è§£æå®Œæˆï¼\næ–‡ä»¶ï¼š${file.name}\nå¤§å°ï¼š${formatFileSize(file.size)}\nå®é™…å­—æ•°ï¼š${actualWords.toLocaleString()} å­—`);
                    }
                })
                .catch(function(error) {
                    console.error('Error extracting DOCX content:', error);
                    fallbackExtraction(arrayBuffer, file, module);
                });
        }

        // å¤‡ç”¨æå–æ–¹æ³•ï¼ˆå½“mammothå¤±è´¥æ—¶ï¼‰
        function fallbackExtraction(arrayBuffer, file, module) {
            console.log('ä½¿ç”¨å¤‡ç”¨è§£ææ–¹æ³•');
            console.log('JSZipåº“åŠ è½½çŠ¶æ€:', typeof JSZip !== 'undefined');
            
            if (typeof JSZip === 'undefined') {
                console.error('JSZip library not loaded');
                alert('æ–‡æ¡£è§£æåº“æœªæ­£ç¡®åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            try {
                // ä½¿ç”¨JSZipè§£æDOCXæ–‡ä»¶
                JSZip.loadAsync(arrayBuffer).then(function(zip) {
                    console.log('JSZipè§£æZIPç»“æ„æˆåŠŸ');
                    const docFile = zip.file("word/document.xml");
                    if (!docFile) {
                        throw new Error('æ‰¾ä¸åˆ°æ–‡æ¡£å†…å®¹æ–‡ä»¶');
                    }
                    return docFile.async("string");
                }).then(function(content) {
                    console.log('æˆåŠŸè¯»å–æ–‡æ¡£XMLå†…å®¹');
                    // ç®€å•çš„XMLæ ‡ç­¾æ¸…ç†
                    let text = content.replace(/<[^>]*>/g, ' ');
                    text = text.replace(/\s+/g, ' ').trim();
                    
                    const actualWords = text.length;
                    console.log('å¤‡ç”¨æ–¹æ³•è§£æå‡ºçš„å†…å®¹é•¿åº¦:', actualWords);
                    
                    // æ ¹æ®æ¨¡å—è®¾ç½®ç›¸åº”çš„å˜é‡
                    if (module === 'detection') {
                        detectionDocumentText = text;
                        document.getElementById('detectionPreviewContent').textContent = 
                            `DOCXæ–‡æ¡£è§£æå®Œæˆ (${file.name})\næ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}\nå®é™…å­—æ•°: ${actualWords.toLocaleString()} å­—\n\nå†…å®¹é¢„è§ˆ:\n` + 
                            text.substring(0, 300) + (text.length > 300 ? '...' : '');
                        document.getElementById('detectionFilePreview').style.display = 'block';
                    } else if (module === 'optimization') {
                        optimizationDocumentText = text;
                        document.getElementById('optimizationPreviewContent').textContent = 
                            `DOCXæ–‡æ¡£è§£æå®Œæˆ (${file.name})\næ–‡ä»¶å¤§å°: ${formatFileSize(file.size)}\nå®é™…å­—æ•°: ${actualWords.toLocaleString()} å­—\n\nå†…å®¹é¢„è§ˆ:\n` + 
                            text.substring(0, 300) + (text.length > 300 ? '...' : '');
                        document.getElementById('optimizationFilePreview').style.display = 'block';
                    } else if (module === 'plagiarism') {
                        currentDocumentText = text;
                        alert(`DOCXæ–‡æ¡£è§£æå®Œæˆï¼\næ–‡ä»¶ï¼š${file.name}\nå¤§å°ï¼š${formatFileSize(file.size)}\nå®é™…å­—æ•°ï¼š${actualWords.toLocaleString()} å­—`);
                    }
                }).catch(function(error) {
                    console.error('Error in fallback extraction:', error);
                    // å¦‚æœæ‰€æœ‰è§£ææ–¹æ³•éƒ½å¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                    handleDocxFallback(file, module, error.message);
                });
            } catch (error) {
                console.error('JSZip error:', error);
                handleDocxFallback(file, module, error.message);
            }
        }

        // å½“DOCXè§£æå®Œå…¨å¤±è´¥æ—¶çš„å¤„ç†æ–¹æ³•
        function handleDocxFallback(file, module, errorMessage) {
            console.log('æ‰€æœ‰DOCXè§£ææ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨åŸºç¡€ä¿¡æ¯æ˜¾ç¤º');
            const fallbackText = `DOCXæ–‡ä»¶è§£æé‡åˆ°é—®é¢˜\næ–‡ä»¶åï¼š${file.name}\næ–‡ä»¶å¤§å°ï¼š${formatFileSize(file.size)}\n\nè§£æå¤±è´¥åŸå› ï¼š${errorMessage}\n\nå»ºè®®ï¼š\n1. è¯·å°†Wordæ–‡æ¡£å¦å­˜ä¸º.txtæ ¼å¼åé‡æ–°ä¸Šä¼ \n2. æˆ–è€…å¤åˆ¶æ–‡æ¡£å†…å®¹ç›´æ¥ç²˜è´´åˆ°æ–‡æœ¬æ¡†ä¸­è¿›è¡Œæ£€æµ‹`;
            
            if (module === 'detection') {
                detectionDocumentText = fallbackText;
                document.getElementById('detectionPreviewContent').textContent = fallbackText;
                document.getElementById('detectionFilePreview').style.display = 'block';
            } else if (module === 'optimization') {
                optimizationDocumentText = fallbackText;
                document.getElementById('optimizationPreviewContent').textContent = fallbackText;
                document.getElementById('optimizationFilePreview').style.display = 'block';
            } else if (module === 'plagiarism') {
                currentDocumentText = fallbackText;
                alert('DOCXæ–‡ä»¶è§£æå¤±è´¥ã€‚å»ºè®®å°†Wordæ–‡æ¡£å¦å­˜ä¸ºTXTæ ¼å¼åé‡æ–°ä¸Šä¼ ã€‚');
            }
        }



        // æµ‹è¯•Ollamaè¿æ¥
        async function testOllamaConnection() {
            const testBtn = document.getElementById('testOllamaBtn');
            testBtn.textContent = 'ğŸ”„ æµ‹è¯•ä¸­...';
            testBtn.disabled = true;
            
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                if (response.ok) {
                    const data = await response.json();
                    const hasDeepSeek = data.models?.some(model => 
                        model.name.toLowerCase().includes('deepseek') || 
                        model.name.toLowerCase().includes('r1')
                    );
                    
                    if (hasDeepSeek) {
                        alert('âœ… Ollamaè¿æ¥æˆåŠŸï¼æ£€æµ‹åˆ°DeepSeekæ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨AIä¼˜åŒ–åŠŸèƒ½ã€‚');
                    } else {
                        alert('âš ï¸ Ollamaè¿æ¥æˆåŠŸï¼Œä½†æœªæ£€æµ‹åˆ°DeepSeek R1æ¨¡å‹ã€‚è¯·å…ˆæ‹‰å–æ¨¡å‹ï¼šollama pull deepseek-r1:8b');
                    }
                } else {
                    throw new Error('è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                alert('âŒ æ— æ³•è¿æ¥åˆ°OllamaæœåŠ¡ï¼\n\nè¯·ç¡®ä¿ï¼š\n1. Ollamaå·²å®‰è£…å¹¶è¿è¡Œ\n2. æœåŠ¡è¿è¡Œåœ¨localhost:11434\n3. å·²æ‹‰å–DeepSeek R1æ¨¡å‹ï¼šollama pull deepseek-r1:8b');
            } finally {
                testBtn.textContent = 'ğŸ” æµ‹è¯•AIè¿æ¥';
                testBtn.disabled = false;
            }
        }

        // ä¼˜åŒ–æ¨¡å¼åˆ‡æ¢ç›‘å¬
        function setupOptimizationModeListeners() {
            const modeInputs = document.querySelectorAll('input[name="optimizationMode"]');
            const aiNotice = document.getElementById('aiModeNotice');
            
            modeInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'ai' || this.value === 'hybrid') {
                        aiNotice.style.display = 'block';
                    } else {
                        aiNotice.style.display = 'none';
                    }
                });
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ™ºèƒ½AIGCæ£€æµ‹ä¸ä¼˜åŒ–å·¥å…·å·²åŠ è½½å®Œæˆ');
            
            // è®¾ç½®ä¼˜åŒ–æ¨¡å¼ç›‘å¬å™¨
            setupOptimizationModeListeners();
            
            // æ£€æŸ¥å¤–éƒ¨åº“åŠ è½½çŠ¶æ€
            setTimeout(function() {
                const mammothLoaded = typeof mammoth !== 'undefined';
                const jszipLoaded = typeof JSZip !== 'undefined';
                
                console.log('=== åº“åŠ è½½çŠ¶æ€æ£€æŸ¥ ===');
                console.log('Mammoth.js åŠ è½½çŠ¶æ€:', mammothLoaded);
                console.log('JSZip åŠ è½½çŠ¶æ€:', jszipLoaded);
                
                if (!mammothLoaded && !jszipLoaded) {
                    console.warn('è­¦å‘Šï¼šæ–‡æ¡£è§£æåº“æœªæ­£ç¡®åŠ è½½ï¼ŒDOCXåŠŸèƒ½å¯èƒ½å—é™');
                    // æ˜¾ç¤ºä¸€ä¸ªä¸æ˜¾çœ¼çš„æç¤º
                    const notice = document.createElement('div');
                    notice.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; font-size: 12px; z-index: 1000; max-width: 300px;';
                    notice.innerHTML = 'âš ï¸ ç½‘ç»œè¿æ¥è¾ƒæ…¢ï¼ŒDOCXè§£æåŠŸèƒ½å¯èƒ½å—é™ã€‚å»ºè®®ä½¿ç”¨TXTæ ¼å¼æ–‡ä»¶ã€‚';
                    document.body.appendChild(notice);
                    
                    // 5ç§’åè‡ªåŠ¨éšè—
                    setTimeout(function() {
                        notice.style.display = 'none';
                    }, 5000);
                }
            }, 2000); // ç»™åº“2ç§’æ—¶é—´åŠ è½½
        });
    </script>
</body>
</html> 